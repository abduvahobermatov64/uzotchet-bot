import os
import json
import sys
import logging
import io
import csv
import asyncio
import uuid # –î–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö ID –¥–ª—è –∫–∞–∂–¥–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏ –≥—Ä—É–∑–∞
import re
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup, KeyboardButton, ReplyKeyboardMarkup, ReplyKeyboardRemove, InputMediaPhoto
from telegram.ext import (
    Application,
    CommandHandler,
    MessageHandler,
    CallbackQueryHandler,
    ConversationHandler,
    ContextTypes,
    filters,
    PicklePersistence # –î–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –±–æ—Ç–∞
)
from telegram.constants import ParseMode, ChatMemberStatus
from datetime import datetime, timedelta 
from typing import Optional, List, Dict, Any
# –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø—Ä–µ—Ñ–∏–∫—Å –¥–ª—è —Ñ–∞–π–ª–æ–≤ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∏–º–µ–Ω–∏ —Å–∫—Ä–∏–ø—Ç–∞
SCRIPT_NAME = os.path.basename(sys.argv[0]).split('.')[0]
FILE_PREFIX = f"{SCRIPT_NAME}_"

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    level=logging.INFO,
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º —É–Ω–∏–∫–∞–ª—å–Ω–æ–µ –∏–º—è –¥–ª—è –ª–æ–≥-—Ñ–∞–π–ª–∞
    filename=f'{FILE_PREFIX}bot_log.txt'
)
logger = logging.getLogger(__name__)

# –°–ø–∏—Å–æ–∫ ID –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤
ADMIN_IDS = {1423619368,8122604388, 433749443}  # –°—É–ø–µ—Ä –ê–¥–º–∏–Ω - –ó–ê–ú–ï–ù–ò–¢–ï
REGULAR_ADMIN_IDS = {5495465770,82291313,556616030} # –ü—Ä–æ—Å—Ç–æ –ê–¥–º–∏–Ω - –ó–ê–ú–ï–ù–ò–¢–ï (–º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ ID —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)

# ID –∏–ª–∏ username –∫–∞–Ω–∞–ª–∞ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —á–ª–µ–Ω—Å—Ç–≤–∞.
# –ï—Å–ª–∏ ID —á–∏—Å–ª–æ–≤–æ–π (–¥–ª—è —á–∞—Å—Ç–Ω—ã—Ö –∫–∞–Ω–∞–ª–æ–≤), –æ–Ω –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –±–µ–∑ –∫–∞–≤—ã—á–µ–∫. –ù–∞–ø—Ä–∏–º–µ—Ä: -1001234567890
# –ï—Å–ª–∏ —ç—Ç–æ username (–¥–ª—è –ø—É–±–ª–∏—á–Ω—ã—Ö –∫–∞–Ω–∞–ª–æ–≤), –æ–Ω –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤ –∫–∞–≤—ã—á–∫–∞—Ö. –ù–∞–ø—Ä–∏–º–µ—Ä: "@mychannel"
REQUIRED_CHANNEL_ID ="" # –ó–ê–ú–ï–ù–ò–¢–ï –Ω–∞ ID –∏–ª–∏ @username. –ï—Å–ª–∏ –æ—Å—Ç–∞–≤–∏—Ç—å "", –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–µ –±—É–¥–µ—Ç –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—å—Å—è.

# –°–æ—Å—Ç–æ—è–Ω–∏—è
class States:
    IDLE = 'IDLE'
    AWAITING_NAME = 'AWAITING_NAME'
    AWAITING_SURNAME = 'AWAITING_SURNAME'
    AWAITING_DEPARTMENT = 'AWAITING_DEPARTMENT'
    AWAITING_POSITION = 'AWAITING_POSITION'
    AWAITING_PHOTO = 'AWAITING_PHOTO'
    AWAITING_DOCS = 'AWAITING_DOCS'
    # AWAITING_QUESTION, AWAITING_ANSWER - –£–î–ê–õ–ï–ù–´
    AWAITING_WORKSHOP = 'AWAITING_WORKSHOP'
    AWAITING_RECEIVING_PLACE = 'AWAITING_RECEIVING_PLACE'
    AWAITING_RECEPTION_TYPE = 'AWAITING_RECEPTION_TYPE'
    AWAITING_GOODS_SUBTYPE = 'AWAITING_GOODS_SUBTYPE' # –ù–æ–≤—ã–π —Å—Ç–∞—Ç—É—Å –¥–ª—è –ø–æ–¥—Ç–∏–ø–æ–≤
    AWAITING_REJECTION_REASON = 'AWAITING_REJECTION_REASON'

ALLOWED_DOCUMENT_TYPES = {
    'pdf', 'doc', 'docx', 'xls', 'xlsx', 'jpg', 'jpeg', 'png', 'bmp',
    'txt', 'csv', 'zip', 'rar', '7z', 'ppt', 'pptx', 'rtf'
}
REQUIRED_DOCUMENTS = [
    "üìÑ –î–æ–≥–æ–≤–æ—Ä", 
    "üìã –°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç", 
    "üìë –ü–∞—Å–ø–æ—Ä—Ç —Ç–æ–≤–∞—Ä–∞", 
    "üì¶ –¢–¢–ù",
    "üîñ –°—á–µ—Ç-—Ñ–∞–∫—Ç—É—Ä–∞", 
    "üìù –¢–ó", 
    "üìã –ó–∞—è–≤–∫–∞ —Ü–µ—Ö–∞" 
    ]

RECEPTION_TYPES_KEYBOARD_MAPPING = {
    "goods": "–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ –∏ –º–∞—Ç–µ—Ä–∏–∞–ª—ã", "raw": "–°—ã—Ä—å–µ",
    "ppe": "–°—Ä–µ–¥—Å—Ç–≤–∞ –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ–π –∑–∞—â–∏—Ç—ã (–°–ò–ó)" }

# –ù–æ–≤—ã–µ –º–∞–ø–ø–∏–Ω–≥–∏ –¥–ª—è –ø–æ–¥—Ç–∏–ø–æ–≤ "–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ –∏ –º–∞—Ç–µ—Ä–∏–∞–ª—ã"
GOODS_SUBTYPES_KEYBOARD_MAPPING = {
    "electric": "–≠–ª–µ–∫—Ç—Ä–∏–∫–∏",
    "mechanic": "–ú–µ—Ö–∞–Ω–∏–∫–∏",
    "hydraulic": "–ì–∏–¥—Ä–∞–≤–ª–∏–∫–∏"
}

# –°—Ç–∞—Ä–∞—è –∫–æ–º–∏—Å—Å–∏—è –¥–ª—è "–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ –∏ –º–∞—Ç–µ—Ä–∏–∞–ª—ã" –±–æ–ª—å—à–µ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –Ω–∞–ø—Ä—è–º—É—é
# COMMISSION_GOODS_IDS: set[int] = {5495465770} 
COMMISSION_RAW_MATERIALS_IDS: set[int] = {1423619368,22256770,1408639216} 
COMMISSION_PPE_IDS: set[int] = {5495465770, 1423619368,518696046,82291313} 

# –ó–ê–ú–ï–ù–ò–¢–ï ID –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–µ ID —á–ª–µ–Ω–æ–≤ –∫–æ–º–∏—Å—Å–∏–π
COMMISSION_GOODS_ELECTRIC_IDS: set[int] = {1423619368,22256770,1408639216} # –ü—Ä–∏–º–µ—Ä: ID –¥–ª—è –∫–æ–º–∏—Å—Å–∏–∏ —ç–ª–µ–∫—Ç—Ä–∏–∫–æ–≤
COMMISSION_GOODS_MECHANIC_IDS: set[int] = {1423619368,82291313,1408639216} # –ü—Ä–∏–º–µ—Ä: ID –¥–ª—è –∫–æ–º–∏—Å—Å–∏–∏ –º–µ—Ö–∞–Ω–∏–∫–æ–≤
COMMISSION_GOODS_HYDRAULIC_IDS: set[int] = {1423619368,518696046,82291313} # –ü—Ä–∏–º–µ—Ä: ID –¥–ª—è –∫–æ–º–∏—Å—Å–∏–∏ –≥–∏–¥—Ä–∞–≤–ª–∏–∫–æ–≤
ALL_COMMISSIONS_BY_KEY: Dict[str, set[int]] = {
    "raw": COMMISSION_RAW_MATERIALS_IDS,
    "ppe": COMMISSION_PPE_IDS,
    "goods_electric": COMMISSION_GOODS_ELECTRIC_IDS,
    "goods_mechanic": COMMISSION_GOODS_MECHANIC_IDS,
    "goods_hydraulic": COMMISSION_GOODS_HYDRAULIC_IDS,
}

# --- –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –¥–∞–Ω–Ω—ã–º–∏ ---
def load_data(filename: str, default_data: Optional[Any] = None) -> Any:
    if default_data is None:
        default_data = []
    try:
        if not os.path.exists(filename):
            with open(filename, 'w', encoding='utf-8') as f:
                json.dump(default_data, f, ensure_ascii=False, indent=4)
            return default_data
        with open(filename, 'r', encoding='utf-8') as f:
            return json.load(f)
    except Exception as e: logger.error(f"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ {filename}: {e}"); return default_data

def save_data(filename: str, data_to_save: Any) -> None:
    try:
        with open(filename, 'w', encoding='utf-8') as f:
            json.dump(data_to_save, f, ensure_ascii=False, indent=4)
    except Exception as e: logger.error(f"–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è {filename}: {e}")

def load_users() -> List[Dict[str, Any]]: return load_data(f'{FILE_PREFIX}users.json', [])
def save_users(users: List[Dict[str, Any]]) -> None: save_data(f'{FILE_PREFIX}users.json', users)
# load_questions –∏ save_questions –£–î–ê–õ–ï–ù–´

# --- –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ ---
def get_user_info(user_id: int) -> Optional[Dict[str, Any]]:
    for user_rec in load_users():
        if user_rec.get('user_id') == user_id: return user_rec
    return None

def is_admin(user_id: int) -> bool: # –°—É–ø–µ—Ä –ê–¥–º–∏–Ω
    try: return int(user_id) in ADMIN_IDS
    except ValueError: return False

def is_regular_admin(user_id: int) -> bool: # –ü—Ä–æ—Å—Ç–æ –ê–¥–º–∏–Ω
    try: return int(user_id) in REGULAR_ADMIN_IDS
    except ValueError: return False

def get_user_state(context: ContextTypes.DEFAULT_TYPE, user_id: int) -> Optional[str]: # user_id –¥–æ–±–∞–≤–ª–µ–Ω –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å –ª–æ–≥–∞–º–∏, –Ω–æ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è
    return context.user_data.get('state') if context.user_data else None

def set_user_state(context: ContextTypes.DEFAULT_TYPE, user_id: int, state: str) -> None: # user_id –¥–æ–±–∞–≤–ª–µ–Ω –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å –ª–æ–≥–∞–º–∏
    if context.user_data is None:
        context.user_data = {}
    logger.info(f"User {user_id} state -> {state}")
    context.user_data['state'] = state

def clear_user_state(context: ContextTypes.DEFAULT_TYPE, user_id: int) -> None:
    # –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Å–ª–æ–≤–∞—Ä–∏ –±–æ–ª—å—à–µ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è, –≤—Å–µ —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ context.user_data
    keys_to_clear = ['state', 
                     'registration_data', # –û—Å–Ω–æ–≤–Ω—ã–µ –∫–ª—é—á–∏ –¥–ª—è –æ—á–∏—Å—Ç–∫–∏
                     'receiving_place', 'documents', 'current_doc_type', 'photo_id', 'photos',
                     # 'messages_to_delete' —É–¥–∞–ª–µ–Ω –∏–∑ –æ—á–∏—Å—Ç–∫–∏, —Ç–∞–∫ –∫–∞–∫ –æ–Ω —É–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è delete_dialogue_messages
                     'photo_time', 'workshop', 'reception_type_name', 'goods_subtype_name', 'messages_to_delete',
                     'reception_type_key', 'photo_datetime_obj', 'rejecting_shipment_id', 'last_bot_message_id']
    if context.user_data:
        for key in keys_to_clear: context.user_data.pop(key, None)
    logger.info(f"State and user_data cleared for user {user_id}.")

def _add_msg_to_delete(context: ContextTypes.DEFAULT_TYPE, message_id: int):
    """–î–æ–±–∞–≤–ª—è–µ—Ç ID —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —Å–ø–∏—Å–æ–∫ –¥–ª—è –ø–æ—Å–ª–µ–¥—É—é—â–µ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è."""
    if context.user_data is None: context.user_data = {}
    if 'messages_to_delete' not in context.user_data:
        context.user_data['messages_to_delete'] = []
    context.user_data['messages_to_delete'].append(message_id)
    logger.debug(f"Added message {message_id} to delete list.") # –î–æ–±–∞–≤–ª–µ–Ω–æ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏

async def delete_dialogue_messages(context: ContextTypes.DEFAULT_TYPE, chat_id: int):
    """–£–¥–∞–ª—è–µ—Ç –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è, —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –≤ —Å–ø–∏—Å–∫–µ 'messages_to_delete'."""
    if context.user_data and 'messages_to_delete' in context.user_data:
        for msg_id in context.user_data['messages_to_delete']:
            try: await context.bot.delete_message(chat_id=chat_id, message_id=msg_id)
            except Exception as e: logger.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ {msg_id} –≤ —á–∞—Ç–µ {chat_id}: {e}")
        context.user_data['messages_to_delete'] = [] # –û—á–∏—â–∞–µ–º —Å–ø–∏—Å–æ–∫ –ø–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è

async def delete_message_after_delay(context: ContextTypes.DEFAULT_TYPE, chat_id: int, message_id: int, delay_seconds: int = 15):
    """–£–¥–∞–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ —á–µ—Ä–µ–∑ —É–∫–∞–∑–∞–Ω–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–µ–∫—É–Ω–¥."""
    async def delete_task():
        try:
            await asyncio.sleep(delay_seconds)
            await context.bot.delete_message(chat_id=chat_id, message_id=message_id)
        except Exception as e:
            logger.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ {message_id} –≤ —á–∞—Ç–µ {chat_id} —á–µ—Ä–µ–∑ {delay_seconds} —Å–µ–∫: {e}")
    # –ó–∞–ø—É—Å–∫–∞–µ–º –∑–∞–¥–∞—á—É –≤ —Ñ–æ–Ω–µ, –Ω–µ –∂–¥–µ–º –µ—ë –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
    asyncio.create_task(delete_task())

# --- –û—Å–Ω–æ–≤–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ ---
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    try:
        effective_user = update.effective_user
        if not effective_user: logger.warning("start: effective_user is None"); return
        user_id = effective_user.id
        
        if REQUIRED_CHANNEL_ID and REQUIRED_CHANNEL_ID.strip(): # –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ ID/username –∫–∞–Ω–∞–ª–∞ –Ω–µ –ø—É—Å—Ç–æ–π
            try:
                member_status = (await context.bot.get_chat_member(chat_id=REQUIRED_CHANNEL_ID, user_id=user_id)).status
                allowed_statuses = [ChatMemberStatus.MEMBER, ChatMemberStatus.ADMINISTRATOR, ChatMemberStatus.CREATOR, ChatMemberStatus.OWNER]
                if member_status not in allowed_statuses:
                    logger.info(f"User {user_id} –Ω–µ —É—á–∞—Å—Ç–Ω–∏–∫ –∫–∞–Ω–∞–ª–∞ {REQUIRED_CHANNEL_ID}. –°—Ç–∞—Ç—É—Å: {member_status}")
                    if update.message: 
                        await update.message.reply_text(
                            f"‚ùå –î–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —ç—Ç–æ–≥–æ –±–æ—Ç–∞ –≤—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–æ–º –∫–∞–Ω–∞–ª–∞ {REQUIRED_CHANNEL_ID}.\n"
                            "–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç–µ—Å—å –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ /start —Å–Ω–æ–≤–∞."
                        )
                    return
                logger.info(f"User {user_id} —É—á–∞—Å—Ç–Ω–∏–∫ –∫–∞–Ω–∞–ª–∞ {REQUIRED_CHANNEL_ID}. –°—Ç–∞—Ç—É—Å: {member_status}")
            except Exception as e_channel_check:
                logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —á–ª–µ–Ω—Å—Ç–≤–∞ {user_id} –≤ {REQUIRED_CHANNEL_ID}: {e_channel_check}")
                if update.message: await update.message.reply_text("‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —á–ª–µ–Ω—Å—Ç–≤–∞ –≤ –∫–∞–Ω–∞–ª–µ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.")
                return
        
        user_json_data = get_user_info(user_id)

        if not user_json_data:
            reg_kb_layout = [[InlineKeyboardButton("‚úÖ –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è", callback_data='start_register')],
                             [InlineKeyboardButton("‚ùå –û—Ç–º–µ–Ω–∞", callback_data='cancel_register')]]
            if update.message: 
                await update.message.reply_text(
                    "üåü *–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ —Å–∏—Å—Ç–µ–º—É —É—á–µ—Ç–∞ –≥—Ä—É–∑–æ–≤!* \n"
                     "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ  \n"
                    "üîê *–ù–µ–æ–±—Ö–æ–¥–∏–º–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è*  \n"
                    "üìù –í–∞–º –ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è —É–∫–∞–∑–∞—Ç—å:  \n"
                    "‚Ä¢ üë§ –ò–º—è  \n"
                    "‚Ä¢ üë• –§–∞–º–∏–ª–∏—é  \n"
                    "‚Ä¢ üè¢ –û—Ç–¥–µ–ª/–¶–µ—Ö  \n"
                    "‚Ä¢ üíº –î–æ–ª–∂–Ω–æ—Å—Ç—å  \n"
                    "ü§ù –ü—Ä–∏—Å–æ–µ–¥–∏–Ω—è–π—Ç–µ—Å—å –∫ –Ω–∞—à–µ–π —Å–∏—Å—Ç–µ–º–µ!  \n"
                    "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ", reply_markup=InlineKeyboardMarkup(reg_kb_layout), parse_mode=ParseMode.MARKDOWN)
            return

        dept = user_json_data.get('department', '–ù/–£'); pos = user_json_data.get('position', '–ù/–£')
        display_name = user_json_data.get('first_name', effective_user.first_name or "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å")

        reply_kb_buttons: List[List[KeyboardButton]] = []
        is_super = is_admin(user_id); is_reg_adm = is_regular_admin(user_id)

        if is_super or is_reg_adm: # –°—É–ø–µ—Ä –ê–¥–º–∏–Ω –∏ –ü—Ä–æ—Å—Ç–æ –ê–¥–º–∏–Ω –≤–∏–¥—è—Ç –∫–Ω–æ–ø–∫—É "–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ"
            reply_kb_buttons.append([KeyboardButton("üì∏ –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ –≥—Ä—É–∑–∞")])
        
        admin_row1: List[KeyboardButton] = []
        admin_row2: List[KeyboardButton] = []
        if is_super: # –ö–Ω–æ–ø–∫–∏ —Ç–æ–ª—å–∫–æ –¥–ª—è –°—É–ø–µ—Ä –ê–¥–º–∏–Ω–∞
            admin_row1.append(KeyboardButton("üë• –°–ø–∏—Å–æ–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤"))
            admin_row1.append(KeyboardButton("üõ°Ô∏è –°–æ—Å—Ç–∞–≤ –∫–æ–º–∏—Å—Å–∏–π"))
            if admin_row1: reply_kb_buttons.append(admin_row1)
            
            admin_row2.append(KeyboardButton("üìä –û—Ç—á–µ—Ç –ø–æ –≥—Ä—É–∑–∞–º"))
            if admin_row2: reply_kb_buttons.append(admin_row2)
        
        reply_kb_markup: Any = ReplyKeyboardRemove() # –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é —É–±–∏—Ä–∞–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É
        if reply_kb_buttons: # –ï—Å–ª–∏ –µ—Å—Ç—å —Ö–æ—Ç—å –∫–∞–∫–∏–µ-—Ç–æ –∫–Ω–æ–ø–∫–∏
            reply_kb_markup = ReplyKeyboardMarkup(reply_kb_buttons, resize_keyboard=True, one_time_keyboard=False)
        
        welcome_msg = (f"üåü *–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!* \nüë§ *–ü—Ä–æ—Ñ–∏–ª—å:*\n ‚Ä¢ –ò–º—è: {display_name}\n"
                       f" ‚Ä¢ –û—Ç–¥–µ–ª/–¶–µ—Ö: {dept}\n ‚Ä¢ –î–æ–ª–∂–Ω–æ—Å—Ç—å: {pos}\n")
        if reply_kb_buttons: welcome_msg += f"üì± *–î–æ—Å—Ç—É–ø–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è:*\n"
        welcome_msg += "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
        set_user_state(context, user_id, States.IDLE)
        if update.message: await update.message.reply_text(welcome_msg, reply_markup=reply_kb_markup, parse_mode=ParseMode.MARKDOWN)

    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –≤ start: {e}", exc_info=True)
        if update.message: await update.message.reply_text("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.", parse_mode=ParseMode.MARKDOWN)
        if update.effective_user: clear_user_state(context, update.effective_user.id)
        # (–ü—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ —Ñ–∞–π–ª–∞ uz3_bot.py - –ß–∞—Å—Ç—å 7)

async def handle_registration_choice(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    query = update.callback_query
    if not query or not query.from_user: return
    await query.answer()
    user_id = query.from_user.id
    if query.data == 'start_register':
        if context.user_data is None: context.user_data = {}
        context.user_data.setdefault('registration_data', {})
        await query.edit_message_text(text="üë§ –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ *–∏–º—è*:", parse_mode=ParseMode.MARKDOWN)
        set_user_state(context, user_id, States.AWAITING_NAME)
    elif query.data == 'cancel_register':
        await query.edit_message_text(text="‚ùå –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –æ—Ç–º–µ–Ω–µ–Ω–∞. /start –¥–ª—è –≤–æ–∑–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è.", parse_mode=ParseMode.MARKDOWN)
        clear_user_state(context, user_id)

async def handle_message(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    try:
        if not update.message or not update.message.text or not update.effective_user: return

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø—Ä–∏—à–ª–æ –≤ –ª–∏—á–Ω–æ–º —á–∞—Ç–µ. –ï—Å–ª–∏ –Ω–µ—Ç - –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º.
        # –í–ê–ñ–ù–û: –ï—Å–ª–∏ –±–æ—Ç –¥–æ–ª–∂–µ–Ω —Ä–∞–±–æ—Ç–∞—Ç—å –≤ –≥—Ä—É–ø–ø–∞—Ö, —ç—Ç—É –ø—Ä–æ–≤–µ—Ä–∫—É –Ω—É–∂–Ω–æ —É–±—Ä–∞—Ç—å.
        if update.message.chat.type != 'private':
            return

        msg_user = update.effective_user
        user_id = msg_user.id
        text_msg = update.message.text

        if context.user_data is None: context.user_data = {}
        current_state = get_user_state(context, user_id) # –ü–µ—Ä–µ–¥–∞–µ–º user_id

        _add_msg_to_delete(context, update.message.message_id)

        if current_state == States.AWAITING_NAME:
            context.user_data.setdefault('registration_data', {})['first_name'] = text_msg
            bot_msg = await update.message.reply_text("üë§ –í–∞—à–∞ *—Ñ–∞–º–∏–ª–∏—è*:", parse_mode=ParseMode.MARKDOWN)
            if bot_msg: _add_msg_to_delete(context, bot_msg.message_id)
            set_user_state(context, user_id, States.AWAITING_SURNAME)
        elif current_state == States.AWAITING_SURNAME:
            context.user_data.setdefault('registration_data', {})['last_name'] = text_msg
            bot_msg = await update.message.reply_text("üè¢ –í–∞—à *–æ—Ç–¥–µ–ª –∏–ª–∏ —Ü–µ—Ö* (–Ω–∞–ø—Ä–∏–º–µ—Ä, –°–∫–ª–∞–¥, –û–ó):", parse_mode=ParseMode.MARKDOWN)
            if bot_msg: _add_msg_to_delete(context, bot_msg.message_id)
            set_user_state(context, user_id, States.AWAITING_DEPARTMENT)
        elif current_state == States.AWAITING_DEPARTMENT:
            context.user_data.setdefault('registration_data', {})['department'] = text_msg
            bot_msg = await update.message.reply_text("üíº –í–∞—à–∞ *–¥–æ–ª–∂–Ω–æ—Å—Ç—å* (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ö–ª–∞–¥–æ–≤—â–∏–∫, –°–ø–µ—Ü–∏–∞–ª–∏—Å—Ç):", parse_mode=ParseMode.MARKDOWN)
            if bot_msg: _add_msg_to_delete(context, bot_msg.message_id)
            set_user_state(context, user_id, States.AWAITING_POSITION)
        elif current_state == States.AWAITING_POSITION:
            reg_data = context.user_data.get('registration_data', {})
            reg_data['position'] = text_msg

            new_user_entry = {
                'user_id': user_id,
                'first_name': reg_data.get('first_name', msg_user.first_name or " "),
                'last_name': reg_data.get('last_name', msg_user.last_name or " "),
                'username': msg_user.username or "",
                'department': reg_data.get('department', '–ù–µ —É–∫–∞–∑–∞–Ω'),
                'position': reg_data.get('position', '–ù–µ —É–∫–∞–∑–∞–Ω–∞'),
                'registration_date': datetime.now().strftime("%d.%m.%Y %H:%M")
            }
            users_data_list = load_users()
            # –û–±–Ω–æ–≤–ª—è–µ–º –∏–ª–∏ –¥–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            users_data_list = [u for u in users_data_list if u.get('user_id') != user_id]
            users_data_list.append(new_user_entry)
            save_users(users_data_list)
            
            await delete_dialogue_messages(context, user_id)
            
            bot_msg = await update.message.reply_text(
                f"‚úÖ *–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞!*\nüë§ –ò–º—è: {new_user_entry['first_name']}\nüë§ –§–∞–º–∏–ª–∏—è: {new_user_entry['last_name']}\n"
                f"üè¢ –û—Ç–¥–µ–ª: {new_user_entry['department']}\nüíº –î–æ–ª–∂–Ω–æ—Å—Ç—å: {new_user_entry['position']}\n"
                f"–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /start –¥–ª—è –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã.", parse_mode=ParseMode.MARKDOWN )
            clear_user_state(context, user_id)
            await start(update, context)
            return # type: ignore
        elif current_state == States.AWAITING_WORKSHOP:
            context.user_data['workshop'] = text_msg 
            bot_msg = await update.message.reply_text("üè≠ *–ú–µ—Å—Ç–æ –ø—Ä–∏—ë–º–∫–∏ —Ç–æ–≤–∞—Ä–∞:*", parse_mode=ParseMode.MARKDOWN)
            if bot_msg: _add_msg_to_delete(context, bot_msg.message_id)
            set_user_state(context, user_id, States.AWAITING_RECEIVING_PLACE)
        elif current_state == States.AWAITING_RECEIVING_PLACE:
            context.user_data['receiving_place'] = text_msg 
            reception_kb_buttons = [] 
            for key_rt, display_text_rt in RECEPTION_TYPES_KEYBOARD_MAPPING.items(): # type: ignore
                reception_kb_buttons.append([InlineKeyboardButton(display_text_rt, callback_data=f"reception_type_{key_rt}")])
            bot_msg = await update.message.reply_text("üìã *–¢–∏–ø –ø—Ä–∏–Ω–∏–º–∞–µ–º–æ–≥–æ –≥—Ä—É–∑–∞:*", reply_markup=InlineKeyboardMarkup(reception_kb_buttons), parse_mode=ParseMode.MARKDOWN)
            if bot_msg: _add_msg_to_delete(context, bot_msg.message_id)
            set_user_state(context, user_id, States.AWAITING_RECEPTION_TYPE)
        elif current_state == States.IDLE or current_state is None:
            is_super = is_admin(user_id)
            is_reg_adm = is_regular_admin(user_id)

            if text_msg == "üì∏ –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ –≥—Ä—É–∑–∞": # –î–æ—Å—Ç—É–ø–Ω–æ –°—É–ø–µ—Ä –ê–¥–º–∏–Ω—É –∏ –ü—Ä–æ—Å—Ç–æ –ê–¥–º–∏–Ω—É
                if not (is_super or is_reg_adm): # –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ —ç—Ç–æ –æ–¥–∏–Ω –∏–∑ –∞–¥–º–∏–Ω–æ–≤
                     user_json_info = get_user_info(user_id) # –û–±—ã—á–Ω–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –Ω—É–∂–Ω–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
                     if not user_json_info:
                        await update.message.reply_text("üîê –î–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ç–æ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å (/start).", parse_mode=ParseMode.MARKDOWN); return # type: ignore
                bot_msg = await update.message.reply_text(
                    "üì∏ *–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—é –≥—Ä—É–∑–∞.*\n\n"
                    "üí° *–í—ã –º–æ–∂–µ—Ç–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ñ–æ—Ç–æ* - –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ —Ñ–æ—Ç–æ –≤–∞–º –±—É–¥–µ—Ç –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –µ—â–µ –æ–¥–Ω–æ –∏–ª–∏ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å.",
                    parse_mode=ParseMode.MARKDOWN
                )
                if bot_msg: _add_msg_to_delete(context, bot_msg.message_id)
                set_user_state(context, user_id, States.AWAITING_PHOTO)
            # "–ó–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å" –∏ "–ò—Å—Ç–æ—Ä–∏—è –≤–æ–ø—Ä–æ—Å–æ–≤" –£–î–ê–õ–ï–ù–´
            elif text_msg == "üë• –°–ø–∏—Å–æ–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤" and is_super:
                await view_users(update, context)
            elif text_msg == "üõ°Ô∏è –°–æ—Å—Ç–∞–≤ –∫–æ–º–∏—Å—Å–∏–π" and is_super:
                await view_commission_members_from_config(update, context)
            elif text_msg == "üìä –û—Ç—á–µ—Ç –ø–æ –≥—Ä—É–∑–∞–º" and is_super:
                await generate_cargo_report(update, context)
            else: 
                user_info_idle = get_user_info(user_id)
                if user_info_idle: # –ï—Å–ª–∏ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω, –Ω–æ –Ω–∞–∂–∞–ª –Ω–µ —Å–≤–æ—é –∫–Ω–æ–ø–∫—É –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ —Ç–µ–∫—Å—Ç
                     await update.message.reply_text('–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –≤–∞–º –∫–Ω–æ–ø–∫–∏ –º–µ–Ω—é –∏–ª–∏ –∫–æ–º–∞–Ω–¥—É /start. –ï—Å–ª–∏ —Ö–æ—Ç–∏—Ç–µ –Ω–∞–ø–∏—Å–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ, –ø–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞ Telegram-–∫–∞–Ω–∞–ª "–ì—Ä—É–ø–ø–∞ –ø–æ –ø—Ä–∏—ë–º–∫–µ 2 –¢–ú–¶ –ê–û –£–ú–ö".', parse_mode=ParseMode.MARKDOWN)
                # –ï—Å–ª–∏ –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω (–Ω–æ –ø—Ä–æ—à–µ–ª –ø—Ä–æ–≤–µ—Ä–∫—É –∫–∞–Ω–∞–ª–∞ –Ω–∞ —ç—Ç–∞–ø–µ /start), —Ç–æ /start —É–∂–µ –¥–æ–ª–∂–µ–Ω –±—ã–ª –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é.
                # –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å else: await start(update, context) –µ—Å–ª–∏ –Ω—É–∂–Ω–æ –µ—â–µ —Ä–∞–∑ –ø–æ–∫–∞–∑–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ /start
        # –°–æ—Å—Ç–æ—è–Ω–∏–µ AWAITING_REJECTION_REASON –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è ConversationHandler
        elif current_state != States.AWAITING_REJECTION_REASON: 
             await update.message.reply_text("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–≤–µ—Ä—à–∏—Ç–µ —Ç–µ–∫—É—â—É—é –æ–ø–µ—Ä–∞—Ü–∏—é –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ /cancel.", parse_mode=ParseMode.MARKDOWN)
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –≤ handle_message: {e}", exc_info=True)
        if update.message: await update.message.reply_text("‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è.", parse_mode=ParseMode.MARKDOWN)
        if update.effective_user: clear_user_state(context, update.effective_user.id)

async def handle_photo(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    try:
        if not update.message or not update.message.photo or not update.effective_user: return
        user_id = update.effective_user.id
        
        if context.user_data is None: context.user_data = {}
        photo_state = get_user_state(context, user_id) # –ü–µ—Ä–µ–¥–∞–µ–º user_id

        _add_msg_to_delete(context, update.message.message_id)

        if photo_state != States.AWAITING_PHOTO:
            await update.message.reply_text("‚ö†Ô∏è *–î–µ–π—Å—Ç–≤–∏–µ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ*. –°–Ω–∞—á–∞–ª–∞ 'üì∏ –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ –≥—Ä—É–∑–∞'.", parse_mode=ParseMode.MARKDOWN); return

        user_json_photo = get_user_info(user_id)
        # –†–∞–∑—Ä–µ—à–∞–µ–º –æ—Ç–ø—Ä–∞–≤–∫—É —Ñ–æ—Ç–æ –°—É–ø–µ—Ä –ê–¥–º–∏–Ω–∞–º –∏ –ü—Ä–æ—Å—Ç–æ –ê–¥–º–∏–Ω–∞–º, –¥–∞–∂–µ –µ—Å–ª–∏ –∏—Ö –Ω–µ—Ç –≤ users.json (–Ω–∞ —Å–ª—É—á–∞–π –µ—Å–ª–∏ –æ–Ω–∏ –Ω–µ —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–ª–∏—Å—å —á–µ—Ä–µ–∑ –±–æ—Ç–∞)
        # –û–±—ã—á–Ω—ã–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º –Ω—É–∂–Ω–∞ –∑–∞–ø–∏—Å—å –≤ users.json (—Ç.–µ. —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è)
        if not user_json_photo and not (is_admin(user_id) or is_regular_admin(user_id)):
            await update.message.reply_text("‚ùå *–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞*. –î–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ç–æ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å (/start).", parse_mode=ParseMode.MARKDOWN); return

        photo_obj = update.message.photo[-1]
        
        # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å–ø–∏—Å–æ–∫ —Ñ–æ—Ç–æ, –µ—Å–ª–∏ –µ–≥–æ –µ—â–µ –Ω–µ—Ç
        if 'photos' not in context.user_data:
            context.user_data['photos'] = []
            context.user_data['photo_time'] = datetime.now().strftime('%d.%m.%Y %H:%M')
            context.user_data['photo_datetime_obj'] = datetime.now()
        
        # –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ —Ñ–æ—Ç–æ –≤ —Å–ø–∏—Å–æ–∫
        context.user_data['photos'].append(photo_obj.file_id)
        
        photo_count = len(context.user_data['photos'])
        
        # –°–æ–∑–¥–∞–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –¥–ª—è –≤—ã–±–æ—Ä–∞: –¥–æ–±–∞–≤–∏—Ç—å –µ—â–µ —Ñ–æ—Ç–æ –∏–ª–∏ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å
        photo_kb_buttons = [
            [InlineKeyboardButton("üì∏ –î–æ–±–∞–≤–∏—Ç—å –µ—â–µ —Ñ–æ—Ç–æ", callback_data="add_more_photos")],
            [InlineKeyboardButton("‚úÖ –ó–∞–≤–µ—Ä—à–∏—Ç—å –∏ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å", callback_data="finish_photos")]
        ]
        reply_markup_photos = InlineKeyboardMarkup(photo_kb_buttons)
        
        bot_msg = await update.message.reply_text(
            f"‚úÖ *–§–æ—Ç–æ {photo_count} –¥–æ–±–∞–≤–ª–µ–Ω–æ*\n\n"
            f"üì∏ –í—Å–µ–≥–æ —Ñ–æ—Ç–æ: {photo_count}\n\n"
            f"–í—ã –º–æ–∂–µ—Ç–µ –¥–æ–±–∞–≤–∏—Ç—å –µ—â–µ —Ñ–æ—Ç–æ –∏–ª–∏ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–∫–∏ –≥—Ä—É–∑–∞.",
            reply_markup=reply_markup_photos,
            parse_mode=ParseMode.MARKDOWN
        )
        if bot_msg: _add_msg_to_delete(context, bot_msg.message_id)
        # –û—Å—Ç–∞–µ–º—Å—è –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ AWAITING_PHOTO, —á—Ç–æ–±—ã –º–æ–∂–Ω–æ –±—ã–ª–æ –¥–æ–±–∞–≤–∏—Ç—å –µ—â–µ —Ñ–æ—Ç–æ
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –≤ handle_photo: {e}", exc_info=True)
        if update.message: await update.message.reply_text("‚ùå *–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ñ–æ—Ç–æ*.", parse_mode=ParseMode.MARKDOWN)
        if update.effective_user: clear_user_state(context, update.effective_user.id)

async def handle_reception_type_choice(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    query = update.callback_query
    if not query or not query.from_user or not query.data : return
    await query.answer()
    user_id = query.from_user.id
    if context.user_data is None: context.user_data = {}

    if query.message: _add_msg_to_delete(context, query.message.message_id) # type: ignore
    cb_data_parts = query.data.split("reception_type_")
    if len(cb_data_parts) < 2:
        if query.message: await query.edit_message_text("–û—à–∏–±–∫–∞ –≤—ã–±–æ—Ä–∞ —Ç–∏–ø–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.")
        return

    selected_reception_key = cb_data_parts[1]
    chosen_reception_display_name = RECEPTION_TYPES_KEYBOARD_MAPPING.get(selected_reception_key)

    if not chosen_reception_display_name:
        if query.message: await query.edit_message_text("–ù–µ–≤–µ—Ä–Ω—ã–π —Ç–∏–ø –ø—Ä–∏–µ–º–∫–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.")
        return
    
    context.user_data['reception_type_name'] = chosen_reception_display_name
    
    # –ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω —Ç–∏–ø "–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ –∏ –º–∞—Ç–µ—Ä–∏–∞–ª—ã", –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –ø–æ–¥—Ç–∏–ø
    if selected_reception_key == "goods":
        context.user_data['reception_type_key'] = "goods" # –í—Ä–µ–º–µ–Ω–Ω–æ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π –∫–ª—é—á
        
        subtype_kb_buttons = []
        for key_st, display_text_st in GOODS_SUBTYPES_KEYBOARD_MAPPING.items():
            subtype_kb_buttons.append([InlineKeyboardButton(display_text_st, callback_data=f"goods_subtype_{key_st}")])
        
        await query.edit_message_text(f"‚úÖ –í—ã–±—Ä–∞–Ω —Ç–∏–ø: *{chosen_reception_display_name}*\n\n–¢–µ–ø–µ—Ä—å –≤—ã–±–µ—Ä–∏—Ç–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:", 
                                      reply_markup=InlineKeyboardMarkup(subtype_kb_buttons), 
                                      parse_mode=ParseMode.MARKDOWN)
        set_user_state(context, user_id, States.AWAITING_GOODS_SUBTYPE)
        return
    else: # –î–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö —Ç–∏–ø–æ–≤ ("–°—ã—Ä—å–µ", "–°–ò–ó") –ª–æ–≥–∏–∫–∞ –æ—Å—Ç–∞–µ—Ç—Å—è –ø—Ä–µ–∂–Ω–µ–π
        context.user_data['reception_type_key'] = selected_reception_key # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–ª—é—á "raw", "ppe"
        if query.message:
            await query.edit_message_text(f"‚úÖ –í—ã–±—Ä–∞–Ω —Ç–∏–ø –ø—Ä–∏–µ–º–∫–∏: *{chosen_reception_display_name}*", parse_mode=ParseMode.MARKDOWN)

    doc_options_inline_kb = [[
        InlineKeyboardButton("üìé –î–æ–±–∞–≤–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç—ã", callback_data="add_docs"),
        InlineKeyboardButton("‚úÖ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –±–µ–∑ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤", callback_data="send_now") ]]
    reply_markup_doc_options_inline = InlineKeyboardMarkup(doc_options_inline_kb)
    
    await context.bot.send_message(chat_id=user_id, text="–î–æ–±–∞–≤–∏—Ç—å —Å–æ–ø—Ä–æ–≤–æ–¥–∏—Ç–µ–ª—å–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã?",
                                   reply_markup=reply_markup_doc_options_inline, parse_mode=ParseMode.MARKDOWN)
    set_user_state(context, user_id, States.AWAITING_DOCS)

async def handle_goods_subtype_choice(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤—ã–±–æ—Ä –ø–æ–¥—Ç–∏–ø–∞ –¥–ª—è '–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ –∏ –º–∞—Ç–µ—Ä–∏–∞–ª—ã'."""
    query = update.callback_query
    if not query or not query.from_user or not query.data: return
    await query.answer()
    user_id = query.from_user.id
    if context.user_data is None: context.user_data = {} # type: ignore

    if query.message: _add_msg_to_delete(context, query.message.message_id)
    cb_data_parts = query.data.split("goods_subtype_")
    if len(cb_data_parts) < 2:
        if query.message: await query.edit_message_text("–û—à–∏–±–∫–∞ –≤—ã–±–æ—Ä–∞ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.")
        return

    selected_subtype_key = cb_data_parts[1]
    chosen_subtype_name = GOODS_SUBTYPES_KEYBOARD_MAPPING.get(selected_subtype_key)

    if not chosen_subtype_name:
        if query.message: await query.edit_message_text("–ù–µ–≤–µ—Ä–Ω–æ–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.")
        return

    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –ø–æ–¥—Ç–∏–ø–∞ –∏ —Ñ–æ—Ä–º–∏—Ä—É–µ–º —Å–æ—Å—Ç–∞–≤–Ω–æ–π –∫–ª—é—á –¥–ª—è –∫–æ–º–∏—Å—Å–∏–∏
    context.user_data['goods_subtype_name'] = chosen_subtype_name
    context.user_data['reception_type_key'] = f"goods_{selected_subtype_key}" # -> "goods_electric", "goods_mechanic" –∏ —Ç.–¥.

    await query.edit_message_text(f"‚úÖ –ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: *{chosen_subtype_name}*", parse_mode=ParseMode.MARKDOWN)

    # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —à–∞–≥—É –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
    await show_doc_options(user_id, context) # type: ignore

async def handle_photo_choice(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤—ã–±–æ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: –¥–æ–±–∞–≤–∏—Ç—å –µ—â–µ —Ñ–æ—Ç–æ –∏–ª–∏ –∑–∞–≤–µ—Ä—à–∏—Ç—å"""
    query = update.callback_query
    if not query or not query.from_user or not query.data: return
    await query.answer()
    user_id = query.from_user.id
    if context.user_data is None: context.user_data = {}
    
    if query.message: _add_msg_to_delete(context, query.message.message_id)
    
    if query.data == "add_more_photos":
        # –û—Å—Ç–∞–µ–º—Å—è –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ AWAITING_PHOTO –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –µ—â–µ —Ñ–æ—Ç–æ
        await query.edit_message_text(
            "üì∏ *–û—Ç–ø—Ä–∞–≤—å—Ç–µ —Å–ª–µ–¥—É—é—â–µ–µ —Ñ–æ—Ç–æ –≥—Ä—É–∑–∞*\n\n"
            "–í—ã –º–æ–∂–µ—Ç–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –µ—â–µ –æ–¥–Ω–æ –∏–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ñ–æ—Ç–æ.",
            parse_mode=ParseMode.MARKDOWN
        )
    elif query.data == "finish_photos":
        # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —à–∞–≥—É - –∑–∞–ø—Ä–æ—Å —Ü–µ—Ö–∞
        photos = context.user_data.get('photos', [])
        if not photos:
            await query.edit_message_text("‚ùå *–û—à–∏–±–∫–∞*: –ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö —Ñ–æ—Ç–æ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.", parse_mode=ParseMode.MARKDOWN)
            return
        
        await query.edit_message_text(
            f"‚úÖ *–§–æ—Ç–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã*\nüì∏ –í—Å–µ–≥–æ —Ñ–æ—Ç–æ: {len(photos)}\n\n"
            "–ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–∫–∏ –≥—Ä—É–∑–∞...",
            parse_mode=ParseMode.MARKDOWN
        )
        bot_msg = await context.bot.send_message(
            chat_id=user_id,
            text="üè≠ *–î–ª—è –∫–∞–∫–æ–≥–æ —Ü–µ—Ö–∞/–ø—Ä–æ–µ–∫—Ç–∞ —ç—Ç–æ—Ç –≥—Ä—É–∑?*",
            parse_mode=ParseMode.MARKDOWN
        )
        if bot_msg: _add_msg_to_delete(context, bot_msg.message_id)
        set_user_state(context, user_id, States.AWAITING_WORKSHOP)

async def handle_docs(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    try:
        if not update.effective_user: return
        doc_event_user_id = update.effective_user.id
        if context.user_data is None: context.user_data = {}

        if update.callback_query:
            query = update.callback_query
            if not query.data or not query.message : return
            await query.answer()
            callback_query_data = query.data
            _add_msg_to_delete(context, query.message.message_id)

            if callback_query_data == "send_now":
                await query.edit_message_text("–ì–æ—Ç–æ–≤–∏–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é (—Ñ–æ—Ç–æ)...")
                await send_cargo_info(update, context, only_photo=True); return
            elif callback_query_data == "add_docs":
                doc_sel_kb = []
                row = []
                for i, name in enumerate(REQUIRED_DOCUMENTS):
                    row.append(InlineKeyboardButton(name, callback_data=f"doc_{i}"))
                    if len(row) == 2:
                        doc_sel_kb.append(row)
                        row = []
                if row: doc_sel_kb.append(row)
                doc_sel_kb.append([InlineKeyboardButton("‚úÖ –ó–∞–≤–µ—Ä—à–∏—Ç—å –∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å", callback_data="finish_and_send")]) # –≠—Ç–∞ –∫–Ω–æ–ø–∫–∞ –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º —Ä—è–¥—É
                context.user_data['documents'] = []
                await query.edit_message_text("üìé *–î–æ–∫—É–º–µ–Ω—Ç—ã:* –í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø:", reply_markup=InlineKeyboardMarkup(doc_sel_kb), parse_mode=ParseMode.MARKDOWN )
                set_user_state(context, doc_event_user_id, States.AWAITING_DOCS); return
            # (–û—Å—Ç–∞–ª—å–Ω–∞—è —á–∞—Å—Ç—å handle_docs —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π callback_query)
# (–ü—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ —Ñ–∞–π–ª–∞ uz3_bot.py - –ß–∞—Å—Ç—å 3)

            # (–ü—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ elif query_data_val == "finish_and_send": –∏–∑ handle_docs)
            elif callback_query_data == "finish_and_send":
                if not context.user_data.get('documents'):
                    await query.answer("–í—ã –Ω–µ –ø—Ä–∏–∫—Ä–µ–ø–∏–ª–∏ –Ω–∏ –æ–¥–Ω–æ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞!", show_alert=True)
                    doc_sel_kb_no_docs_finish = []; row = []
                    for i, name in enumerate(REQUIRED_DOCUMENTS):
                        row.append(InlineKeyboardButton(name, callback_data=f"doc_{i}"))
                        if len(row) == 2:
                            doc_sel_kb_no_docs_finish.append(row)
                            row = []
                    if row: doc_sel_kb_no_docs_finish.append(row)
                    doc_sel_kb_no_docs_finish.append([InlineKeyboardButton("‚úÖ –ó–∞–≤–µ—Ä—à–∏—Ç—å –∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å", callback_data="finish_and_send")])

                    reply_markup_doc_sel_no_docs_finish = InlineKeyboardMarkup(doc_sel_kb_no_docs_finish)
                    try:
                        await query.edit_message_text("‚ùå *–ù–µ—Ç –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤!*\n–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –∏–ª–∏ –∑–∞–≤–µ—Ä—à–∏—Ç–µ:",reply_markup=reply_markup_doc_sel_no_docs_finish, parse_mode=ParseMode.MARKDOWN)
                    except Exception: # type: ignore
                         await query.message.reply_text("‚ùå *–ù–µ—Ç –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤!*\n–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –∏–ª–∏ –∑–∞–≤–µ—Ä—à–∏—Ç–µ:",reply_markup=reply_markup_doc_sel_no_docs_finish, parse_mode=ParseMode.MARKDOWN)
                    return

                confirm_kb_layout = [[InlineKeyboardButton("‚úÖ –î–∞", callback_data="confirm_send")],[InlineKeyboardButton("‚ùå –ù–µ—Ç", callback_data="cancel_send")]]
                reply_markup_confirm_final = InlineKeyboardMarkup(confirm_kb_layout)

                sender_info_docs_prev = get_user_info(doc_event_user_id)
                department_docs_prev = sender_info_docs_prev.get('department', '–ù/–£') if sender_info_docs_prev else '–ù/–£'
                reception_type_preview = context.user_data.get('reception_type_name', '–ù/–£')

                preview_text_final = "üìã *–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π:*\n"
                preview_text_final += f"üè¢ –û—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å: {department_docs_prev}\n"
                preview_text_final += f"üè≠ –¶–µ—Ö: {context.user_data.get('workshop', '–ù/–£')}\n"
                preview_text_final += f"üìç –ú–µ—Å—Ç–æ: {context.user_data.get('receiving_place', '–ù/–£')}\n"
                preview_text_final += f"üìã –¢–∏–ø: {reception_type_preview}\n"
                preview_text_final += "üì∏ –§–æ—Ç–æ (–±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ)\n"
                current_docs_for_preview = context.user_data.get('documents', [])
                if current_docs_for_preview:
                    preview_text_final += "üìé *–î–æ–∫—É–º–µ–Ω—Ç—ã:*\n"
                    for doc_data_item_prev in current_docs_for_preview: # type: ignore
                        preview_text_final += f"‚Ä¢ {doc_data_item_prev.get('type','N/A')}: {doc_data_item_prev.get('file_name','N/A')}\n"
                if len(preview_text_final) > 4000: preview_text_final = preview_text_final[:3990] + "...(–æ–±—Ä.)"
                
                await query.edit_message_text( f"{preview_text_final}\n–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é?", 
                                              reply_markup=reply_markup_confirm_final, parse_mode=ParseMode.MARKDOWN)
                return
            elif callback_query_data == "confirm_send":
                await query.edit_message_text("–û—Ç–ø—Ä–∞–≤–ª—è–µ–º...") # type: ignore
                await send_cargo_info(update, context, only_photo=False)
                return
            elif callback_query_data == "cancel_send":
                await query.edit_message_text("‚ùå –û—Ç–ø—Ä–∞–≤–∫–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞. /start –¥–ª—è –Ω–∞—á–∞–ª–∞.", parse_mode=ParseMode.MARKDOWN)
                clear_user_state(context, doc_event_user_id); return
            elif callback_query_data.startswith("doc_"):
                idx = int(callback_query_data.split('_')[1]) # type: ignore
                if 0 <= idx < len(REQUIRED_DOCUMENTS):
                    context.user_data['current_doc_type'] = REQUIRED_DOCUMENTS[idx]
                    msg_txt = f"üìé –û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–∞–π–ª –¥–ª—è *{REQUIRED_DOCUMENTS[idx]}*\n(–§–æ—Ä–º–∞—Ç—ã: {', '.join(ALLOWED_DOCUMENT_TYPES)})"
                    try: await query.edit_message_text(msg_txt, parse_mode=ParseMode.MARKDOWN) # type: ignore
                    except Exception: await query.message.reply_text(msg_txt, parse_mode=ParseMode.MARKDOWN) # Fallback
                    set_user_state(context, doc_event_user_id, States.AWAITING_DOCS)
                else: await query.answer("–ù–µ–≤–µ—Ä–Ω—ã–π —Ç–∏–ø.", show_alert=True)
                return
        elif update.message and update.message.document: # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–∏–ª —Ñ–∞–π–ª –¥–æ–∫—É–º–µ–Ω—Ç–∞
            _add_msg_to_delete(context, update.message.message_id)

            state = get_user_state(context, doc_event_user_id)
            if state != States.AWAITING_DOCS or not context.user_data.get('current_doc_type'):
                await update.message.reply_text("‚ùå –°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –¥–æ–∫—É–º–µ–Ω—Ç–∞ –∫–Ω–æ–ø–∫–æ–π.", parse_mode=ParseMode.MARKDOWN); return
            
            doc_file = update.message.document; ext = ""; 
            if doc_file.file_name and '.' in doc_file.file_name: ext = doc_file.file_name.split('.')[-1].lower()
            if ext not in ALLOWED_DOCUMENT_TYPES: await update.message.reply_text(f"‚ùå *–§–æ—Ä–º–∞—Ç {ext} –Ω–µ —Ä–∞–∑—Ä–µ—à–µ–Ω!*", parse_mode=ParseMode.MARKDOWN); return
            
            doc_info: Dict[str,str] = {'file_id': doc_file.file_id, 'file_name': doc_file.file_name or "—Ñ–∞–π–ª", 'type': str(context.user_data.get('current_doc_type','–ù/–¢'))}
            if not isinstance(context.user_data.get('documents'), list): context.user_data['documents'] = []
            context.user_data['documents'].append(doc_info); context.user_data.pop('current_doc_type', None) # type: ignore
            
            kb_next = []; row = []
            for i, name in enumerate(REQUIRED_DOCUMENTS):
                row.append(InlineKeyboardButton(name, callback_data=f"doc_{i}"))
                if len(row) == 2:
                    kb_next.append(row)
                    row = []
            if row: kb_next.append(row)
            kb_next.append([InlineKeyboardButton("‚úÖ –ó–∞–≤–µ—Ä—à–∏—Ç—å –∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å", callback_data="finish_and_send")])

            bot_msg = await update.message.reply_text(f"‚úÖ –î–æ–∫—É–º–µ–Ω—Ç *{doc_info['type']}* ({doc_info['file_name']}) –¥–æ–±–∞–≤–ª–µ–Ω!\n–í—ã–±–µ—Ä–∏—Ç–µ —Å–ª–µ–¥—É—é—â–∏–π –∏–ª–∏ –∑–∞–≤–µ—Ä—à–∏—Ç–µ:", reply_markup=InlineKeyboardMarkup(kb_next), parse_mode=ParseMode.MARKDOWN) # type: ignore
            if bot_msg: _add_msg_to_delete(context, bot_msg.message_id)
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –≤ handle_docs: {e}", exc_info=True)
        target = update.effective_message or (update.callback_query.message if update.callback_query else None)
        if target: await target.reply_text("‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤.", parse_mode=ParseMode.MARKDOWN)
        if update.effective_user: clear_user_state(context, update.effective_user.id)

async def show_doc_options(user_id: int, context: ContextTypes.DEFAULT_TYPE) -> None:
    """–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∫–Ω–æ–ø–∫–∏ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤."""
    doc_options_inline_kb = [[
        InlineKeyboardButton("üìé –î–æ–±–∞–≤–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç—ã", callback_data="add_docs"),
        InlineKeyboardButton("‚úÖ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –±–µ–∑ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤", callback_data="send_now") # Callback data –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –±–µ–∑ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
    ]]
    reply_markup_doc_options_inline = InlineKeyboardMarkup(doc_options_inline_kb)    
    bot_msg = await context.bot.send_message(chat_id=user_id, text="–î–æ–±–∞–≤–∏—Ç—å —Å–æ–ø—Ä–æ–≤–æ–¥–∏—Ç–µ–ª—å–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã?",
                                   reply_markup=reply_markup_doc_options_inline, parse_mode=ParseMode.MARKDOWN) # type: ignore
    if bot_msg: _add_msg_to_delete(context, bot_msg.message_id)
    set_user_state(context, user_id, States.AWAITING_DOCS)

def _get_document_buttons_for_shipment(shipment_id: str, documents_list: List[Dict[str,str]]) -> List[List[InlineKeyboardButton]]:
    doc_buttons_rows: List[List[InlineKeyboardButton]] = []
    if documents_list:
        row: List[InlineKeyboardButton] = []
        for idx, doc_info_item in enumerate(documents_list):
            doc_type_display_btn = doc_info_item.get('type', '–î–æ–∫—É–º–µ–Ω—Ç').replace("üìÑ", "").replace("üìã", "").strip()
            button_text_content = f"{doc_type_display_btn}"[:30] # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ —Ç–∏–ø, —á—Ç–æ–±—ã –∫–Ω–æ–ø–∫–∏ –Ω–µ –±—ã–ª–∏ —Å–ª–∏—à–∫–æ–º —à–∏—Ä–æ–∫–∏–º–∏
            callback_data_doc_btn = f"getdoc_{shipment_id}_{idx}"
            if len(callback_data_doc_btn) > 64:
                 logger.warning(f"–°–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–π callback_data –¥–ª—è –∫–Ω–æ–ø–∫–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞: {callback_data_doc_btn}")
            row.append(InlineKeyboardButton(button_text_content, callback_data=callback_data_doc_btn))
            if len(row) == 2:
                doc_buttons_rows.append(row)
                row = []
        if row: # –ï—Å–ª–∏ –æ—Å—Ç–∞–ª–æ—Å—å –Ω–µ—á–µ—Ç–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–Ω–æ–ø–æ–∫, –¥–æ–±–∞–≤–ª—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π —Ä—è–¥
            doc_buttons_rows.append(row)
    return doc_buttons_rows

async def send_cargo_info(update: Update, context: ContextTypes.DEFAULT_TYPE, only_photo: bool = False) -> None:
    sender_user_obj = update.effective_user
    if not sender_user_obj and update.callback_query:
        sender_user_obj = update.callback_query.from_user
 # type: ignore
    if not sender_user_obj:
        logger.error("–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è –≤ send_cargo_info")
        effective_message = update.effective_message or (update.callback_query.message if update.callback_query else None)
        if effective_message: await effective_message.reply_text("–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è."); return
    try:
        if context.user_data is None: context.user_data = {}
        if context.bot_data is None: context.bot_data = {}
            
        sender_db_record = get_user_info(sender_user_obj.id)
        sender_name_cargo, department_name_cargo, position_name_cargo = "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π", "–ù/–£", "–ù/–£"
        if sender_db_record:
            sender_name_parts_db = [n for n in [sender_db_record.get('first_name'), sender_db_record.get('last_name')] if n]
            sender_name_cargo = " ".join(sender_name_parts_db).strip() or f"ID {sender_user_obj.id}"
            department_name_cargo = sender_db_record.get('department', '–ù/–£'); position_name_cargo = sender_db_record.get('position', '–ù/–£') # type: ignore
        elif sender_user_obj.first_name: 
            sender_name_parts_tg = [n for n in [sender_user_obj.first_name, sender_user_obj.last_name] if n]
            sender_name_cargo = " ".join(sender_name_parts_tg).strip() or f"User ID {sender_user_obj.id}"

        workshop_name = context.user_data.get('workshop', '–ù/–£'); receiving_place = context.user_data.get('receiving_place', '–ù/–£')
        
        # –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ —Ñ–æ—Ç–æ (–ø–æ–¥–¥–µ—Ä–∂–∫–∞ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Ñ–æ—Ç–æ)
        photos_list = context.user_data.get('photos', [])
        # –î–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ä–æ–µ –ø–æ–ª–µ photo_id
        if not photos_list:
            old_photo_id = context.user_data.get('photo_id')
            if old_photo_id:
                photos_list = [old_photo_id]
        
        photo_time_str = str(context.user_data.get('photo_time', datetime.now().strftime('%d.%m.%Y %H:%M')))
        photo_dt_obj = context.user_data.get('photo_datetime_obj', datetime.now())
        if not isinstance(photo_dt_obj, datetime):
             try: photo_dt_obj = datetime.strptime(photo_time_str, '%d.%m.%Y %H:%M')
             except (ValueError, TypeError): photo_dt_obj = datetime.now() 
        if not photos_list:
            target_msg = update.effective_message or (update.callback_query.message if update.callback_query else None) # type: ignore
            if target_msg: await target_msg.reply_text("‚ùå *–û—à–∏–±–∫–∞* –§–æ—Ç–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.", parse_mode=ParseMode.MARKDOWN)
            logger.warning(f"–§–æ—Ç–æ –Ω–µ—Ç –¥–ª—è {sender_user_obj.id}."); return

        shipment_id = str(uuid.uuid4())
        docs_for_shipment: List[Dict[str, str]] = list(context.user_data.get('documents', [])) if not only_photo else [] # type: ignore

        # –§–æ—Ä–º–∏—Ä—É–µ–º —É–ø—Ä–æ—â–µ–Ω–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ (—Ç–æ–ª—å–∫–æ –∫–ª—é—á–µ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ: –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å, —Ü–µ—Ö, –¥–∞—Ç–∞)
        caption_parts = [ "üì¶ *–ù–æ–≤—ã–π –≥—Ä—É–∑!!!!*", "‚îÄ"*20, f"üë§ –û—Ç–ø—Ä: {sender_name_cargo} ({department_name_cargo}, {position_name_cargo})",
                          f"üè≠ –¶–µ—Ö: {workshop_name}", f"üìÖ –î–∞—Ç–∞: {photo_time_str}" ]
        reception_type_name = context.user_data.get('reception_type_name', '–ù/–£')
        reception_type_key = context.user_data.get('reception_type_key')
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–∏–ø –ø—Ä–∏–µ–º–∫–∏ –¥–ª—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–π –ª–æ–≥–∏–∫–∏, –Ω–æ –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º –≤ –∫–∞—Ä—Ç–æ—á–∫–µ
        goods_subtype_name = context.user_data.get('goods_subtype_name', '')
        full_reception_name = f"{reception_type_name} ({goods_subtype_name})" if goods_subtype_name else reception_type_name
        
        main_caption = "  \n".join(caption_parts)

        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–µ—Ä–≤–æ–µ —Ñ–æ—Ç–æ –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ –∏ —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö —Ñ–æ—Ç–æ
        first_photo_id = photos_list[0] if photos_list else None
        shipment_entry: Dict[str, Any] = {
            'shipment_id': shipment_id, 'photo_id': first_photo_id, 'photos': photos_list, 'caption_text': main_caption, 'documents': docs_for_shipment,
            'sender_user_id': sender_user_obj.id, 'sender_name': sender_name_cargo, 'workshop': workshop_name, 
            'receiving_place': receiving_place, 'reception_type_key': reception_type_key, 
            'photo_time_str': photo_time_str, 'photo_datetime_obj': photo_dt_obj.isoformat(), 
            'reception_type': full_reception_name, 'status': '–æ–∂–∏–¥–∞–µ—Ç —Ä–µ—à–µ–Ω–∏—è', 'decision_time_obj': None, 
            'decision_maker_name': None, 'decision_maker_id': None, 'processing_time_str': None, 'sent_messages': {},
            'commission_notification_messages': {}, 'commission_signing_status': 'not_applicable', 
            'commission_signatures': {}, 'required_commission_members': [], 'commission_process_initiator_name': None, 
            'commission_process_initiator_id': None, 'commission_process_initiation_time': None, }
        context.bot_data.setdefault('shipments', {})[shipment_id] = shipment_entry
        logger.info(f"–ì—Ä—É–∑ {shipment_id} –æ—Ç {sender_user_obj.id} –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω.")

        all_users = load_users(); sent_count = 0
        for user_rec in all_users:
            user_id_to_send = user_rec.get('user_id')
            if not user_id_to_send: continue
            is_super_admin_receiver = is_admin(user_id_to_send)
            
            doc_buttons = _get_document_buttons_for_shipment(shipment_id, docs_for_shipment)
            action_buttons = []
            if is_super_admin_receiver: # –¢–æ–ª—å–∫–æ –°—É–ø–µ—Ä –ê–¥–º–∏–Ω –≤–∏–¥–∏—Ç –∫–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π
                action_buttons = [
                    [InlineKeyboardButton("‚úÖ –ü—Ä–∏–Ω—è—Ç–æ", callback_data=f"cargoaction_{shipment_id}_accepted"),
                     InlineKeyboardButton("‚ùå –û—Ç–∫–∞–∑–∞–Ω–æ", callback_data=f"cargoaction_{shipment_id}_rejected")],
                    [InlineKeyboardButton("üî¨ –í –ª–∞–±–æ—Ä–∞—Ç–æ—Ä–∏—é", callback_data=f"cargoaction_{shipment_id}_lab_check")],
                    [InlineKeyboardButton("üóëÔ∏è –£–¥–∞–ª–∏—Ç—å (–¥–ª—è –≤—Å–µ—Ö)", callback_data=f"delshipment_{shipment_id}")]]
            
            final_buttons = doc_buttons + action_buttons
            reply_markup_for_receiver: Optional[InlineKeyboardMarkup] = InlineKeyboardMarkup(final_buttons) if final_buttons else None

            try:
                # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤—Å–µ —Ñ–æ—Ç–æ –≤ –º–µ–¥–∏–∞-–≥—Ä—É–ø–ø–µ (–æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –≤ –æ–¥–Ω–æ–º —Ä—è–¥—É, –∫–æ–º–ø–∞–∫—Ç–Ω–æ)
                photo_msg_ids = []
                if len(photos_list) > 1:
                    # –ï—Å–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ñ–æ—Ç–æ - –∏—Å–ø–æ–ª—å–∑—É–µ–º –º–µ–¥–∏–∞-–≥—Ä—É–ø–ø—É
                    media_group = []
                    for idx, photo_file_id in enumerate(photos_list):
                        # –ü–µ—Ä–≤–æ–µ —Ñ–æ—Ç–æ —Å –æ–ø–∏—Å–∞–Ω–∏–µ–º, –æ—Å—Ç–∞–ª—å–Ω—ã–µ –±–µ–∑ –æ–ø–∏—Å–∞–Ω–∏—è
                        if idx == 0:
                            media_group.append(InputMediaPhoto(
                                media=str(photo_file_id),
                                caption=main_caption,
                                parse_mode=ParseMode.MARKDOWN
                            ))
                        else:
                            media_group.append(InputMediaPhoto(
                                media=str(photo_file_id)
                            ))
                    
                    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –º–µ–¥–∏–∞-–≥—Ä—É–ø–ø—É (—Ñ–æ—Ç–æ –±—É–¥—É—Ç –≤ –æ–¥–Ω–æ–º —Ä—è–¥—É, –∫–æ–º–ø–∞–∫—Ç–Ω–æ)
                    sent_messages_group = await context.bot.send_media_group(
                        chat_id=user_id_to_send,
                        media=media_group
                    )
                    # –°–æ—Ö—Ä–∞–Ω—è–µ–º ID –≤—Å–µ—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –∏–∑ –º–µ–¥–∏–∞-–≥—Ä—É–ø–ø—ã
                    photo_msg_ids = [msg.message_id for msg in sent_messages_group]
                else:
                    # –ï—Å–ª–∏ –æ–¥–Ω–æ —Ñ–æ—Ç–æ - –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ–±—ã—á–Ω—ã–º —Å–ø–æ—Å–æ–±–æ–º
                    photo_msg = await context.bot.send_photo(
                        chat_id=user_id_to_send,
                        photo=str(photos_list[0]),
                        caption=main_caption,
                        parse_mode=ParseMode.MARKDOWN
                    )
                    photo_msg_ids.append(photo_msg.message_id)
                
                # –ó–∞—Ç–µ–º, –µ—Å–ª–∏ –µ—Å—Ç—å –∫–Ω–æ–ø–∫–∏, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –∏—Ö –æ—Ç–¥–µ–ª—å–Ω—ã–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º
                action_msg_id = None # ID —Å–æ–æ–±—â–µ–Ω–∏—è —Å –∫–Ω–æ–ø–∫–∞–º–∏
                if reply_markup_for_receiver:
                    action_msg = await context.bot.send_message(chat_id=user_id_to_send, text="–°–ø—Ä–æ–≤–æ–¥–∏—Ç–µ–ª—å–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã !:", reply_markup=reply_markup_for_receiver)
                    action_msg_id = action_msg.message_id

                s_dict = context.bot_data.setdefault('shipments', {}); s_entry = s_dict.setdefault(shipment_id, {})
                sent_m_dict = s_entry.setdefault('sent_messages', {}); 
                # –°–æ—Ö—Ä–∞–Ω—è–µ–º ID –ø–µ—Ä–≤–æ–≥–æ —Ñ–æ—Ç–æ –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ –∏ —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö ID
                sent_m_dict[str(user_id_to_send)] = {
                    'photo_msg_id': photo_msg_ids[0] if photo_msg_ids else None, 
                    'photo_msg_ids': photo_msg_ids,
                    'action_msg_id': action_msg_id
                }
                sent_count += 1
            except Exception as e: logger.error(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ç–æ –≥—Ä—É–∑–∞ {user_id_to_send}: {e}"); continue 

            # "–í–∞–∂–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –¥–ª—è –∫–æ–º–∏—Å—Å–∏–∏" - –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –í–°–ï–ú (–µ—Å–ª–∏ –µ—Å—Ç—å —Ç–µ–∫—Å—Ç)
            comm_notify_parts: List[str] = []
            if reception_type_name and reception_type_name != '–ù–µ —É–∫–∞–∑–∞–Ω':
                comm_notify_parts = [f"üîî *–í–ê–ñ–ù–û–ï –£–í–ï–î–û–ú–õ–ï–ù–ò–ï –î–õ–Ø –ö–û–ú–ò–°–°–ò–ò ({str(full_reception_name).upper()})*", "–ü—Ä–æ—à—É —Å–ª–µ–¥—É—é—â–∏—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –ø—Ä–∏–µ–º–Ω–æ–π –∫–æ–º–∏—Å—Å–∏–∏ –ø—Ä–∏–±—ã—Ç—å –≤ –º–µ—Å—Ç–æ –ø—Ä–∏–µ–º–∫–∏ ", "*" + ("‚îÄ"*20) + "*", ]
                s_r_key = shipment_entry.get('reception_type_key')
                if s_r_key and s_r_key.startswith("goods_"): comm_notify_parts.extend([" ‚Ä¢ –°–ø–µ—Ü–∏–∞–ª–∏—Å—Ç —Ü–µ—Ö–∞", " ‚Ä¢ –°–ø–µ—Ü–∏–∞–ª–∏—Å—Ç (—Å–µ—Ä–≤–∏—Å–∞ –ø–æ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—é)", " ‚Ä¢ –°–ø–µ—Ü–∏–∞–ª–∏—Å—Ç —Ç–µ—Ö.–¥–∏—Ä–µ–∫—Ü–∏–∏", " ‚Ä¢ –°–æ—Ç—Ä—É–¥–Ω–∏–∫ –°–ë", " ‚Ä¢ –°–æ—Ç—Ä—É–¥–Ω–∏–∫ –°–£–ú–ó" ])
                elif s_r_key == "raw": comm_notify_parts.extend([" ‚Ä¢ –°–ø–µ—Ü–∏–∞–ª–∏—Å—Ç —Ü–µ—Ö–∞", " ‚Ä¢ –°–æ—Ç—Ä—É–¥–Ω–∏–∫ –°–ë", " ‚Ä¢ –°–ø–µ—Ü–∏–∞–ª–∏—Å—Ç –°–£–ú–ó"])
                elif s_r_key == "ppe": comm_notify_parts.extend([" ‚Ä¢ –ù–∞—á–∞–ª—å–Ω–∏–∫ –£–ü–ë", " ‚Ä¢ –ù–∞—á–∞–ª—å–Ω–∏–∫ –û–û–¢", " ‚Ä¢ –ù–∞—á–∞–ª—å–Ω–∏–∫ –≠–°–ü–¶/–°–ü–¶", " ‚Ä¢ –°–ø–µ—Ü–∏–∞–ª–∏—Å—Ç –°–ë", " ‚Ä¢ –°–ø–µ—Ü–∏–∞–ª–∏—Å—Ç –ø—Ä–æ—Ñ–∫–æ–º–∞", " ‚Ä¢ –°–ø–µ—Ü–∏–∞–ª–∏—Å—Ç –°–£–ú–ó"])
                else: comm_notify_parts.append(f" (–°–æ—Å—Ç–∞–≤ –¥–ª—è '{reception_type_name}' –Ω–µ –¥–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω)")
                comm_notify_parts.append("*" + ("‚îÄ"*20) + "*")
            if comm_notify_parts:
                final_comm_notify_text = "\n".join(comm_notify_parts)
                try:
                    comm_notify_msg = await context.bot.send_message(chat_id=user_id_to_send, text=final_comm_notify_text, parse_mode=ParseMode.MARKDOWN )
                    s_d_comm = context.bot_data.setdefault('shipments', {}); s_e_c = s_d_comm.setdefault(shipment_id, {}) # type: ignore
                    c_n_m_s = s_e_c.setdefault('commission_notification_messages', {}); c_n_m_s[user_id_to_send] = comm_notify_msg.message_id # type: ignore
                except Exception as e: logger.error(f"–û—à–∏–±–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∫–æ–º–∏—Å—Å–∏–∏ {user_id_to_send}: {e}")
        
        reply_target_sender = update.effective_message or (update.callback_query.message if update.callback_query else None)
        if reply_target_sender:
            success_text = f"‚úÖ –ò–Ω—Ñ–æ –æ –≥—Ä—É–∑–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ ({sent_count} –ø–æ–ª—å–∑.)."
            if docs_for_shipment: success_text += f"\nüìé –î–æ–∫—É–º–µ–Ω—Ç–æ–≤ –¥–ª—è –≤—ã–±–æ—Ä–∞: {len(docs_for_shipment)}"
            
            await delete_dialogue_messages(context, sender_user_obj.id)

            if update.callback_query and update.callback_query.message:
                 success_msg = await context.bot.send_message(chat_id=sender_user_obj.id, text=success_text, parse_mode=ParseMode.MARKDOWN)
                 # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–¥–∞–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 15 —Å–µ–∫—É–Ω–¥
                 await delete_message_after_delay(context, sender_user_obj.id, success_msg.message_id, 15)
            elif update.message: 
                success_msg = await update.message.reply_text(success_text, parse_mode=ParseMode.MARKDOWN)
                # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–¥–∞–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 15 —Å–µ–∫—É–Ω–¥
                await delete_message_after_delay(context, update.message.chat_id, success_msg.message_id, 15)
        clear_user_state(context, sender_user_obj.id) # –ü–µ—Ä–µ–¥–∞–µ–º user_id

    except Exception as e:
        logger.error(f"–ö—Ä–∏—Ç. –æ—à–∏–±–∫–∞ –≤ send_cargo_info: {e}", exc_info=True)
        target_crit_err = update.effective_message or (update.callback_query.message if update.callback_query else None)
        if target_crit_err: await target_crit_err.reply_text("‚ùå *–ö—Ä–∏—Ç. –æ—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏.* –°–æ–æ–±—â–∏—Ç–µ –∞–¥–º–∏–Ω—É.", parse_mode=ParseMode.MARKDOWN)
        if sender_user_obj: clear_user_state(context, sender_user_obj.id)

async def get_document_handler(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    query = update.callback_query
    if not query or not query.data or not query.from_user: return
    await query.answer()
    try:
        if context.bot_data is None: context.bot_data = {}
        parts = query.data.split('_');
        if len(parts) < 3: 
            if query.message: await query.message.reply_text("‚ùå –û—à–∏–±–∫–∞: –Ω–µ–≤–µ—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ."); return
        prefix, shipment_id, idx_str = parts[0], parts[1], parts[2]; doc_idx = int(idx_str)
        if prefix == "getdoc":
            s_data: Dict[str, Dict[str, Any]] = context.bot_data.get('shipments', {})
            if shipment_id in s_data:
                s_info = s_data[shipment_id]; docs: List[Dict[str, str]] = s_info.get('documents', []) # type: ignore
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ docs —è–≤–ª—è–µ—Ç—Å—è —Å–ø–∏—Å–∫–æ–º –∏ doc_idx –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ –¥–æ–ø—É—Å—Ç–∏–º—ã—Ö –ø—Ä–µ–¥–µ–ª–∞—Ö
                if isinstance(docs, list) and 0 <= doc_idx < len(docs):
                    doc = docs[doc_idx]; file_id, name, type_ = doc.get('file_id'), doc.get('file_name', '–î–æ–∫'), doc.get('type', '')
                    if file_id: await context.bot.send_document(query.from_user.id, file_id, filename=name, caption=f"{type_}" if type_ else name )
                    else: logger.warning(f"–ù–µ—Ç file_id: {doc_idx}, {shipment_id}"); await _extracted_from_get_document_handler_25(query, "‚ùå –ù–µ—Ç –∏–Ω—Ñ–æ –æ —Ñ–∞–π–ª–µ.")
                else: logger.warning(f"–ù–µ–≤–µ—Ä–Ω—ã–π idx {doc_idx} –¥–ª—è {shipment_id}"); await _extracted_from_get_document_handler_25(query, "‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –¥–æ–∫—É–º–µ–Ω—Ç.")
            else: logger.warning(f"–ì—Ä—É–∑ {shipment_id} –Ω–µ –Ω–∞–π–¥–µ–Ω."); await _extracted_from_get_document_handler_25(query, "‚ùå –ò–Ω—Ñ–æ –æ –≥—Ä—É–∑–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.")
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ get_document_handler '{query.data}': {e}", exc_info=True)
        if query.message: await query.message.reply_text("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç.")
 # –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è, —á—Ç–æ–±—ã –Ω–µ –¥—É–±–ª–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥
async def _extracted_from_get_document_handler_25(query: Any, arg1: str): # –î–æ–±–∞–≤–ª–µ–Ω—ã —Ç–∏–ø—ã –¥–ª—è query –∏ arg1
    if query.message: await query.message.reply_text(arg1)

async def handle_delete_shipment(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    query = update.callback_query
    if not query or not query.from_user or not query.data: return

    user_id = query.from_user.id
    if not is_admin(user_id):
        await query.answer("‚ùå –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω.", show_alert=True)
        return

    await query.answer("–£–¥–∞–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —É –≤—Å–µ—Ö –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π...")

    try:
        if context.bot_data is None: context.bot_data = {}
        
        parts = query.data.split('_', 1)
        if len(parts) < 2:
            logger.error(f"–ù–µ–≤–µ—Ä–Ω—ã–π callback –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è: {query.data}")
            if query.message: await query.message.reply_text("–û—à–∏–±–∫–∞: –Ω–µ–≤–µ—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è.")
            return
        
        shipment_id = parts[1]
        shipments = context.bot_data.setdefault('shipments', {})
        
        if shipment_id in shipments:
            s_data = shipments[shipment_id]
            user_info = get_user_info(user_id)
            admin_name = f"{user_info.get('first_name','')} {user_info.get('last_name',' ')}".strip() if user_info else f"ID {user_id}"
            
            deleted_caption = (f"üóëÔ∏è *–ì—Ä—É–∑ —É–¥–∞–ª–µ–Ω*\n"
                               f"‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n"
                               f"–î–∞–Ω–Ω—ã–π –≥—Ä—É–∑ (ID: `...{shipment_id[-6:]}`) –±—ã–ª —É–¥–∞–ª–µ–Ω –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º ({admin_name}).\n"
                               f"–î–∞—Ç–∞ —É–¥–∞–ª–µ–Ω–∏—è: {datetime.now().strftime('%d.%m.%Y %H:%M')}")

            sent_messages = s_data.get('sent_messages', {})
            comm_notif_messages = s_data.get('commission_notification_messages', {})
            
            # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è —Å —Ñ–æ—Ç–æ –∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
            for chat_id_del, msg_data in sent_messages.items():
                try:
                    chat_id_int = int(chat_id_del)
                    # –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ ID –≤—Å–µ—Ö —Ñ–æ—Ç–æ –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞—Ä–æ–µ –ø–æ–ª–µ –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
                    photo_msg_ids = msg_data.get('photo_msg_ids', [])
                    if not photo_msg_ids and msg_data.get('photo_msg_id'):
                        photo_msg_ids = [msg_data.get('photo_msg_id')]
                    
                    # –†–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º –ø–µ—Ä–≤–æ–µ —Ñ–æ—Ç–æ —Å –æ–ø–∏—Å–∞–Ω–∏–µ–º —É–¥–∞–ª–µ–Ω–∏—è
                    if photo_msg_ids:
                        await context.bot.edit_message_caption(
                            chat_id=chat_id_int, 
                            message_id=int(photo_msg_ids[0]), 
                            caption=deleted_caption, 
                            reply_markup=None, 
                            parse_mode=ParseMode.MARKDOWN
                        )
                        # –£–¥–∞–ª—è–µ–º –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Ñ–æ—Ç–æ
                        for photo_msg_id in photo_msg_ids[1:]:
                            try:
                                await context.bot.delete_message(chat_id=chat_id_int, message_id=int(photo_msg_id))
                            except Exception as e:
                                logger.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —Ñ–æ—Ç–æ {photo_msg_id} –≤ —á–∞—Ç–µ {chat_id_int}: {e}")
                    
                    # –£–¥–∞–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∫–Ω–æ–ø–∫–∞–º–∏ –¥–µ–π—Å—Ç–≤–∏–π, –µ—Å–ª–∏ –µ—Å—Ç—å
                    if msg_data.get('action_msg_id'):
                        try:
                            await context.bot.delete_message(chat_id=chat_id_int, message_id=int(msg_data.get('action_msg_id')))
                        except Exception as e:
                            logger.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∫–Ω–æ–ø–∫–∞–º–∏ {msg_data.get('action_msg_id')} –≤ —á–∞—Ç–µ {chat_id_int}: {e}")
                except Exception as e: 
                    logger.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è {chat_id_del}: {e}")
            
            # –£–¥–∞–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∫–æ–º–∏—Å—Å–∏–∏
            for chat_id_del, msg_id_del in comm_notif_messages.items():
                try:
                    await context.bot.delete_message(chat_id=int(chat_id_del), message_id=int(msg_id_del))
                except Exception as e:
                    logger.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ {msg_id_del} –≤ —á–∞—Ç–µ {chat_id_del}: {e}")
            
            del shipments[shipment_id]
            logger.info(f"–°—É–ø–µ—Ä-–∞–¥–º–∏–Ω {user_id} —É–¥–∞–ª–∏–ª –≥—Ä—É–∑ {shipment_id} –∏ –≤—Å–µ —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è.")
            deleted_msg = await context.bot.send_message(user_id, f"‚úÖ –ì—Ä—É–∑ ID ...{shipment_id[-6:]} –±—ã–ª –ø–æ–º–µ—á–µ–Ω –∫–∞–∫ —É–¥–∞–ª–µ–Ω–Ω—ã–π –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.")
            # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–¥–∞–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 15 —Å–µ–∫—É–Ω–¥
            await delete_message_after_delay(context, user_id, deleted_msg.message_id, 15)
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –≤ handle_delete_shipment –¥–ª—è '{query.data}': {e}", exc_info=True)
        await context.bot.send_message(user_id, "‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏—è.")

def _format_commission_signatures_text(signatures: Dict[Any, Dict[str, Any]]) -> str:
    if not signatures: return ""
    lines = ["\n*–ü–æ–¥–ø–∏—Å–∏ –∫–æ–º–∏—Å—Å–∏–∏:*"]
    for user_id, sig_data in signatures.items():
        if not isinstance(sig_data, dict) or sig_data.get('status') == 'pending': continue
        user_info = get_user_info(int(user_id))
        user_name = f"ID {user_id}"
        if user_info: user_name = f"{user_info.get('first_name','')} {user_info.get('last_name',' ')}".strip() or user_info.get('username') or f"ID {user_id}"
        
        status = sig_data.get('status')
        if status == 'signed':
            timestamp_iso = sig_data.get('timestamp'); time_str = ""
            if timestamp_iso:
                try: time_str = f" –≤ {datetime.fromisoformat(timestamp_iso).strftime('%H:%M:%S')}"
                except (ValueError, TypeError): pass
            lines.append(f"  ‚úÖ {user_name} (–ü–æ–¥–ø–∏—Å–∞–Ω–æ{time_str})")
        elif status == 'rejected':
            reason = sig_data.get('rejection_reason', '–ø—Ä–∏—á–∏–Ω–∞ –Ω–µ —É–∫–∞–∑–∞–Ω–∞')
            lines.append(f"  ‚ùå {user_name} (–û—Ç–∫–ª–æ–Ω–µ–Ω–æ: {reason[:40]}...)")
    return "\n".join(lines) if len(lines) > 1 else ""

async def handle_cargo_action(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    # (–ö–æ–¥ —ç—Ç–æ–π —Ñ—É–Ω–∫—Ü–∏–∏ –±—ã–ª –≤ –ø—Ä–µ–¥—ã–¥—É—â–µ–º –æ—Ç–≤–µ—Ç–µ, –ß–ê–°–¢–¨ 4, –∏ –æ–Ω –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∑–¥–µ—Å—å –ø–æ–ª–Ω–æ—Å—Ç—å—é)
    # ... (–í—Å—Ç–∞–≤—å—Ç–µ —Å—é–¥–∞ –ø–æ–ª–Ω—ã–π –∫–æ–¥ —Ñ—É–Ω–∫—Ü–∏–∏ handle_cargo_action –∏–∑ –æ—Ç–≤–µ—Ç–∞ –ß–∞—Å—Ç–∏ 4)
    query = update.callback_query
    if not query or not query.from_user or not query.data: logger.warning("handle_cargo_action: –Ω–µ—Ç query/user/data"); return
    await query.answer()
    user_clicked = query.from_user; user_info = get_user_info(user_clicked.id)
    user_name = f"{user_info.get('first_name','')} {user_info.get('last_name',' ')}".strip() or user_info.get('username') or f"ID {user_clicked.id}" if user_info else f"ID {user_clicked.id}"
    user_pos = user_info.get('position', '–ù/–î') if user_info else '–ù/–î'
    try:
        if context.bot_data is None: context.bot_data = {}; logger.warning("bot_data –±—ã–ª None")
        parts = query.data.split('_', 2)
        if len(parts) < 3: logger.error(f"–ü–ª–æ—Ö–æ–π callback: {query.data}"); return
        _, shipment_id, action_key_raw = parts; action_key = action_key_raw.strip()
        shipments: Dict[str, Dict[str, Any]] = context.bot_data.setdefault('shipments', {})
        if shipment_id not in shipments:
            logger.warning(f"–ì—Ä—É–∑ {shipment_id} –Ω–µ –Ω–∞–π–¥–µ–Ω ({action_key}).")
            if query.message: await query.edit_message_reply_markup(reply_markup=None); await query.message.reply_text("–ò–Ω—Ñ–æ –æ –≥—Ä—É–∑–µ —É—Å—Ç–∞—Ä–µ–ª–∞.")
            return
        s_data = shipments[shipment_id]; orig_caption = str(s_data.get('caption_text', "–ò–Ω—Ñ–æ.")); current_s = str(s_data.get('status', '–ù/–£')).lower()
        doc_btns = _get_document_buttons_for_shipment(shipment_id, s_data.get('documents', [])); caption_update = ""; final_action = False
        
        r_key_comm = s_data.get('reception_type_key'); comm_ids: set[int] = set()
        if isinstance(r_key_comm, str): comm_ids = ALL_COMMISSIONS_BY_KEY.get(r_key_comm, set())
        r_name_disp = s_data.get('reception_type', '–ù/–£')

        if action_key in ["accepted", "lab_approved"] and comm_ids and s_data.get('commission_signing_status') not in ['all_signed', 'rejected', 'pending']:
            can_init_c = (action_key == "accepted" and current_s in ['–æ–∂–∏–¥–∞–µ—Ç —Ä–µ—à–µ–Ω–∏—è', '–Ω–µ–∏–∑–≤–µ—Å—Ç–µ–Ω', None]) or \
                         (action_key == "lab_approved" and current_s == '–æ–∂–∏–¥–∞–µ—Ç –ø—Ä–æ—Ç–æ–∫–æ–ª')
            if not can_init_c: await query.answer(f"–ù–µ–∞–∫—Ç—É–∞–ª—å–Ω–æ. –°—Ç–∞—Ç—É—Å: {current_s}", True); return
            s_data.update({'status': '–æ–∂–∏–¥–∞–µ—Ç –ø–æ–¥–ø–∏—Å–∞–Ω–∏—è –∫–æ–º–∏—Å—Å–∏–µ–π', 'commission_signing_status': 'pending', 'required_commission_members': list(comm_ids),
                           'commission_signatures': {uid: {'status': 'pending'} for uid in comm_ids}, 'commission_process_initiator_name': user_name,
                           'commission_process_initiator_id': user_clicked.id, 'commission_process_initiation_time': datetime.now().isoformat()}) # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—Ä–µ–º—è –∏–Ω–∏—Ü–∏–∞—Ü–∏–∏
            caption_update = (f"\n\n*{'‚îÄ'*20}*\n‚úçÔ∏è *–°—Ç–∞—Ç—É—Å: –û–∂–∏–¥–∞–µ—Ç –ø–æ–¥–ø–∏—Å–∞–Ω–∏—è –ê–∫—Ç–∞ –∫–æ–º–∏—Å—Å–∏–µ–π ({r_name_disp})*\n"
                               f"–ò–Ω–∏—Ü–∏–∏—Ä–æ–≤–∞–Ω–æ: {user_name} ({user_pos})\n–ö–æ–≥–¥–∞: {datetime.now().strftime('%d.%m.%Y %H:%M')}")
            
            # --- –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ —á–ª–µ–Ω–∞–º –∫–æ–º–∏—Å—Å–∏–∏ ---
            for m_id in comm_ids: 
                m_info = get_user_info(m_id)
                if m_info:
                    m_name = f"{m_info.get('first_name','')} {m_info.get('last_name',' ')}".strip() or f"ID {m_id}"
                    txt_to_m = (f"–£–≤. {m_name},\n–ü—Ä–æ—Å–∏–º —Ä–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å –ê–∫—Ç –¥–ª—è –≥—Ä—É–∑–∞ ID ...{shipment_id[-6:]} ({r_name_disp}).\n\n–î–µ—Ç–∞–ª–∏:\n{orig_caption}\n" # –£–±—Ä–∞–ª –ª–∏—à–Ω–∏–π \n
                                f"–û—Ç–ø—Ä: {s_data.get('sender_name', '–ù/–î')}, –¶–µ—Ö: {s_data.get('workshop', '–ù/–î')}")
                    sign_btns_m = [[InlineKeyboardButton("‚úÖ –ü–æ–¥–ø–∏—Å–∞—Ç—å",callback_data=f"commact_{shipment_id}_sign"), InlineKeyboardButton("‚ùå –û—Ç–∫–∞–∑–∞—Ç—å—Å—è",callback_data=f"commact_{shipment_id}_rejectreason")]]
                    try: 
                        await context.bot.send_message(m_id, txt_to_m, reply_markup=InlineKeyboardMarkup(sign_btns_m), parse_mode=ParseMode.MARKDOWN)
                    except Exception as e: logger.error(f"–ù–µ —É–¥–∞–ª–æ—Å—å —É–≤–µ–¥–æ–º–∏—Ç—å {m_id}: {e}")
                else: logger.warning(f"–ß–ª–µ–Ω –∫–æ–º–∏—Å—Å–∏–∏ {m_id} (—Ç–∏–ø: {r_name_disp}) –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω.")
        elif action_key == "lab_check":
            if current_s not in ['–æ–∂–∏–¥–∞–µ—Ç —Ä–µ—à–µ–Ω–∏—è', '–Ω–µ–∏–∑–≤–µ—Å—Ç–µ–Ω', None]: await query.answer(f"–†–µ—à–µ–Ω–∏–µ –ø—Ä–∏–Ω—è—Ç–æ: {current_s}", True); return
            s_data['status'] = '–æ–∂–∏–¥–∞–µ—Ç –ø—Ä–æ—Ç–æ–∫–æ–ª'
            s_data['lab_check_time_obj'] = datetime.now().isoformat() # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—Ä–µ–º—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ –ª–∞–±–æ—Ä–∞—Ç–æ—Ä–∏—é
            caption_update = (f"\n\n*{'‚îÄ'*20}*\nüî¨ *–í –ª–∞–±–æ—Ä–∞—Ç–æ—Ä–∏—é.*\n–û–∂–∏–¥–∞–µ—Ç—Å—è –ø—Ä–æ—Ç–æ–∫–æ–ª.\n"
                               f"–ò–Ω–∏—Ü: {user_name} ({user_pos})\n–ö–æ–≥–¥–∞: {datetime.now().strftime('%d.%m.%Y %H:%M')}")
        else:
            act_map = {"accepted":"–ü—Ä–∏–Ω—è—Ç–æ", "rejected":"–û—Ç–∫–∞–∑–∞–Ω–æ", "lab_approved":"–ü—Ä–∏–Ω—è—Ç–æ (–ª–∞–±.)", "lab_rejected":"–û—Ç–∫–∞–∑–∞–Ω–æ (–ª–∞–±.)"}
            act_readable = act_map.get(action_key)
            if not act_readable: logger.warning(f"–ù–µ–∏–∑–≤. action: {action_key} –¥–ª—è {shipment_id}"); return
            can_proc = False
            if action_key=="accepted" and not comm_ids and current_s in ['–æ–∂–∏–¥–∞–µ—Ç —Ä–µ—à–µ–Ω–∏—è','–Ω–µ–∏–∑–≤–µ—Å—Ç–µ–Ω',None]: can_proc=True
            elif action_key=="lab_approved" and not comm_ids and current_s=='–æ–∂–∏–¥–∞–µ—Ç –ø—Ä–æ—Ç–æ–∫–æ–ª': can_proc=True
            elif action_key in ["rejected","lab_rejected"] and current_s not in ["–ø—Ä–∏–Ω—è—Ç–æ","–æ—Ç–∫–∞–∑–∞–Ω–æ","–ø—Ä–∏–Ω—è—Ç–æ (–ª–∞–±.)","–æ—Ç–∫–∞–∑–∞–Ω–æ (–ª–∞–±.)","–ø—Ä–∏–Ω—è—Ç–æ –∫–æ–º–∏—Å—Å–∏–µ–π","–æ—Ç–∫–∞–∑–∞–Ω–æ –∫–æ–º–∏—Å—Å–∏–µ–π"]:
                if (action_key=="rejected" and current_s in ['–æ–∂–∏–¥–∞–µ—Ç —Ä–µ—à–µ–Ω–∏—è','–Ω–µ–∏–∑–≤–µ—Å—Ç–µ–Ω',None,'–æ–∂–∏–¥–∞–µ—Ç –ø—Ä–æ—Ç–æ–∫–æ–ª','–æ–∂–∏–¥–∞–µ—Ç –ø–æ–¥–ø–∏—Å–∞–Ω–∏—è –∫–æ–º–∏—Å—Å–∏–µ–π']) or \
                   (action_key=="lab_rejected" and current_s=='–æ–∂–∏–¥–∞–µ—Ç –ø—Ä–æ—Ç–æ–∫–æ–ª'): can_proc=True
            if not can_proc: await query.answer(f"–ù–µ–∞–∫—Ç—É–∞–ª—å–Ω–æ. –°—Ç–∞—Ç—É—Å: {current_s}", True); return
            s_data.update({'status':act_readable, 'decision_time_obj':datetime.now().isoformat(), 'decision_maker_name':user_name, 'decision_maker_id':user_clicked.id})
            final_action = True
            proc_sec = _calculate_processing_time_seconds(s_data)
            time_el_str = format_timedelta_for_report(proc_sec) if proc_sec is not None else "–ù/–î"
            s_data['processing_time_str'] = time_el_str
            caption_update = (f"\n\n*{'‚îÄ'*20}*\nüöö *–°—Ç–∞—Ç—É—Å: {act_readable}*\n–ö–µ–º: {user_name} ({user_pos})\n"
                               f"–ö–æ–≥–¥–∞: {datetime.now().strftime('%d.%m.%Y %H:%M')}\n‚è±Ô∏è *–í—Ä–µ–º—è:* {time_el_str}")
            if s_data.get('commission_signing_status') in ['all_signed', 'rejected']: caption_update += _format_commission_signatures_text(s_data.get('commission_signatures', {}))
            s_id_notify = s_data.get('sender_user_id')
            if s_id_notify and isinstance(s_id_notify, int) and s_id_notify != user_clicked.id:
                try: 
                    update_msg = await context.bot.send_message(s_id_notify, f"üîî –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ –≥—Ä—É–∑—É ID ...{shipment_id[-6:]}:\n{caption_update.strip()}", parse_mode=ParseMode.MARKDOWN)
                    # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–¥–∞–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 15 —Å–µ–∫—É–Ω–¥
                    await delete_message_after_delay(context, s_id_notify, update_msg.message_id, 15)
                except Exception as e: logger.error(f"–ù–µ —É–¥–∞–ª–æ—Å—å —É–≤–µ–¥–æ–º–∏—Ç—å {s_id_notify}: {e}")
        
        comm_sign_status = s_data.get('commission_signing_status')
        if final_action or comm_sign_status in ['all_signed', 'rejected', 'not_applicable']: # –î–æ–±–∞–≤–ª–µ–Ω–æ 'not_applicable' –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π, –µ—Å–ª–∏ –∫–æ–º–∏—Å—Å–∏—è –Ω–µ –Ω—É–∂–Ω–∞
            comm_notif_msgs = s_data.get('commission_notification_messages', {})
            if isinstance(comm_notif_msgs, dict):
                for uid_del, mid_del in comm_notif_msgs.items():
                    try: await context.bot.delete_message(chat_id=int(uid_del), message_id=int(mid_del))
                    except Exception as e: logger.warning(f"–ù–µ —É–¥. —É–¥–∞–ª–∏—Ç—å —É–≤–µ–¥. {mid_del} –¥–ª—è {shipment_id} —É {uid_del}: {e}")
                s_data['commission_notification_messages'] = {}
        
        for chat_id_str_upd, msg_id_upd in s_data.get('sent_messages', {}).items():
            try:
                is_super_admin_for_btns = is_admin(int(chat_id_str_upd)) # <-- –ü–ï–†–ï–ú–ï–©–ï–ù–û –í–í–ï–†–•
                chat_id_int_upd = int(chat_id_str_upd)
                final_caption_upd = orig_caption + caption_update
                if len(final_caption_upd) > 1024: final_caption_upd = final_caption_upd[:1020] + "..."
                
                updated_kb_edit = list(doc_btns)                

                # –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É "–£–¥–∞–ª–∏—Ç—å" –≤—Å–µ–≥–¥–∞, –µ—Å–ª–∏ —ç—Ç–æ —Å—É–ø–µ—Ä–∞–¥–º–∏–Ω
                if is_super_admin_for_btns:
                    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ –∫–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è, —á—Ç–æ–±—ã –Ω–µ –¥—É–±–ª–∏—Ä–æ–≤–∞—Ç—å
                    has_delete_button = any('delshipment_' in btn.callback_data for row in updated_kb_edit for btn in row)
                    if not has_delete_button:
                        updated_kb_edit.append([InlineKeyboardButton("üóëÔ∏è –£–¥–∞–ª–∏—Ç—å (–¥–ª—è –≤—Å–µ—Ö)", callback_data=f"delshipment_{shipment_id}")])
                current_s_for_btns = str(s_data.get('status', '')).lower()
                
                if is_super_admin_for_btns:
                    if current_s_for_btns == '–æ–∂–∏–¥–∞–µ—Ç —Ä–µ—à–µ–Ω–∏—è':
                        updated_kb_edit.extend([[InlineKeyboardButton("‚úÖ –ü—Ä–∏–Ω—è—Ç–æ", callback_data=f"cargoaction_{shipment_id}_accepted"),
                                                 InlineKeyboardButton("‚ùå –û—Ç–∫–∞–∑–∞–Ω–æ", callback_data=f"cargoaction_{shipment_id}_rejected")],
                                                [InlineKeyboardButton("üî¨ –í –ª–∞–±–æ—Ä–∞—Ç–æ—Ä–∏—é", callback_data=f"cargoaction_{shipment_id}_lab_check")]])
                    elif current_s_for_btns == '–æ–∂–∏–¥–∞–µ—Ç –ø—Ä–æ—Ç–æ–∫–æ–ª':
                         updated_kb_edit.extend([[InlineKeyboardButton("‚úÖ –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç (–ª–∞–±)", callback_data=f"cargoaction_{shipment_id}_lab_approved"),
                                                   InlineKeyboardButton("‚ùå –ù–µ —Å–æ–æ—Ç–≤. (–ª–∞–±)", callback_data=f"cargoaction_{shipment_id}_lab_rejected"),]])
                final_reply_markup_edit_val: Optional[InlineKeyboardMarkup] = InlineKeyboardMarkup(updated_kb_edit) if updated_kb_edit else None
                if final_action or comm_sign_status in ['all_signed', 'rejected'] or current_s_for_btns == '–æ–∂–∏–¥–∞–µ—Ç –ø–æ–¥–ø–∏—Å–∞–Ω–∏—è –∫–æ–º–∏—Å—Å–∏–µ–π':
                    final_reply_markup_edit_val = InlineKeyboardMarkup(doc_btns) if doc_btns else None
                
                msg_ids = s_data.get('sent_messages', {}).get(chat_id_str_upd, {})
                photo_msg_id = msg_ids.get('photo_msg_id')
                action_msg_id = msg_ids.get('action_msg_id')

                try:
                    if photo_msg_id:
                        await context.bot.edit_message_caption(chat_id=chat_id_int_upd, message_id=int(photo_msg_id), caption=final_caption_upd, parse_mode=ParseMode.MARKDOWN)
                    if action_msg_id:
                        await context.bot.edit_message_reply_markup(chat_id=chat_id_int_upd, message_id=int(action_msg_id), reply_markup=final_reply_markup_edit_val)
                except Exception as e: logger.error(f"–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è ({action_key}) –¥–ª—è {chat_id_str_upd}: {e}")
            except Exception as e: logger.error(f"–û—à–∏–±–∫–∞ –≤ —Ü–∏–∫–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è {chat_id_str_upd}: {e}")
    except ValueError as ve: logger.error(f"–û—à–∏–±–∫–∞ —Ä–∞–∑–±–æ—Ä–∞ callback '{query.data}': {ve}", exc_info=True)
    except Exception as e: logger.error(f"–ö—Ä–∏—Ç. –æ—à–∏–±–∫–∞ –≤ handle_cargo_action –¥–ª—è '{query.data}': {e}", exc_info=True)

# --- –§–£–ù–ö–¶–ò–ò –û–¢–û–ë–†–ê–ñ–ï–ù–ò–Ø (–ê–î–ú–ò–ù) ---
# (view_questions –£–î–ê–õ–ï–ù–ê)
async def view_users(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    # (–ö–æ–¥ —Ñ—É–Ω–∫—Ü–∏–∏ view_users, –∫–∞–∫ –≤ –ø—Ä–µ–¥—ã–¥—É—â–µ–º –ø–æ–ª–Ω–æ–º —Ñ–∞–π–ª–µ, –¥–æ—Å—Ç—É–ø —Ç–æ–ª—å–∫–æ –¥–ª—è –°—É–ø–µ—Ä –ê–¥–º–∏–Ω–∞)
    # ... (–≤—Å—Ç–∞–≤—å—Ç–µ –∫–æ–¥ view_users)
    if not update.effective_user or not update.message: return
    if not is_admin(update.effective_user.id): # –¢–æ–ª—å–∫–æ –°—É–ø–µ—Ä –ê–¥–º–∏–Ω
        await update.message.reply_text("–≠—Ç–∞ –∫–æ–º–∞–Ω–¥–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –≥–ª–∞–≤–Ω—ã–º –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º.")
        return
    all_users_for_view = load_users()
    if not all_users_for_view: await update.message.reply_text("‚ùå *–ù–µ—Ç –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.*", parse_mode=ParseMode.MARKDOWN); return
    full_text = "üë• *–°–ø–∏—Å–æ–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤:*\n"; current_dept = None
    for user_rec_vu in sorted(all_users_for_view, key=lambda u: (str(u.get('department', '~')).lower(), str(u.get('first_name', '')).lower())):
        dept_display_vu = user_rec_vu.get('department', '–ë–µ–∑ –æ—Ç–¥–µ–ª–∞')
        if dept_display_vu != current_dept:
            if current_dept is not None: full_text += "\n" 
            full_text += f"üè¢ *{dept_display_vu}:*\n"; current_dept = dept_display_vu
        name_vu = f"{user_rec_vu.get('first_name','')} {user_rec_vu.get('last_name',' ')}".strip() or user_rec_vu.get('username') or f"ID: {user_rec_vu.get('user_id')}"
        pos_vu = user_rec_vu.get('position', '–ë–µ–∑ –¥–æ–ª–∂–Ω–æ—Å—Ç–∏')
        full_text += f"   ‚Ä¢ {name_vu}"
        if pos_vu and pos_vu != '–ë–µ–∑ –¥–æ–ª–∂–Ω–æ—Å—Ç–∏': full_text += f" _{pos_vu}_"
        full_text += f"  `(ID: {user_rec_vu.get('user_id')})`\n"
    full_text += f"\n*–í—Å–µ–≥–æ:* {len(all_users_for_view)}"
    for i in range(0, len(full_text), 4000): await update.message.reply_text(full_text[i:i+4000], parse_mode=ParseMode.MARKDOWN)


async def view_commission_members_from_config(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    # (–ö–æ–¥ —Ñ—É–Ω–∫—Ü–∏–∏ view_commission_members_from_config, –∫–∞–∫ –≤ –ø—Ä–µ–¥—ã–¥—É—â–µ–º –ø–æ–ª–Ω–æ–º —Ñ–∞–π–ª–µ, –¥–æ—Å—Ç—É–ø —Ç–æ–ª—å–∫–æ –¥–ª—è –°—É–ø–µ—Ä –ê–¥–º–∏–Ω–∞)
    # ... (–≤—Å—Ç–∞–≤—å—Ç–µ –∫–æ–¥ view_commission_members_from_config)
    if not update.effective_user or not update.message: return
    if not is_admin(update.effective_user.id): # –¢–æ–ª—å–∫–æ –°—É–ø–µ—Ä –ê–¥–º–∏–Ω
        await update.message.reply_text("–≠—Ç–∞ –∫–æ–º–∞–Ω–¥–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –≥–ª–∞–≤–Ω—ã–º –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º."); return
    full_text = "üë• *–°–æ—Å—Ç–∞–≤—ã –ü—Ä–∏–µ–º–Ω—ã—Ö –ö–æ–º–∏—Å—Å–∏–π:*\n"; any_filled = False

    if context.bot_data is None: context.bot_data = {}
    shipments_data = context.bot_data.get('shipments', {})
    signature_counts: Dict[int, int] = {} 

    for shipment in shipments_data.values():
        signatures = shipment.get('commission_signatures', {})
        if isinstance(signatures, dict):
            for user_id, sig_data in signatures.items():
                if isinstance(sig_data, dict) and sig_data.get('status') == 'signed':
                    signature_counts[user_id] = signature_counts.get(user_id, 0) + 1

    for comm_key, member_ids in ALL_COMMISSIONS_BY_KEY.items():
        comm_name = RECEPTION_TYPES_KEYBOARD_MAPPING.get(comm_key, comm_key.capitalize())
        full_text += f"\nüõ°Ô∏è *–ö–æ–º–∏—Å—Å–∏—è: {comm_name}* (–ö–ª—é—á: `{comm_key}`)"
        if not member_ids: full_text += " (ID –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã)\n"; continue
        any_filled = True; found_count = 0
        for uid in member_ids:
            user_info = get_user_info(uid)
            sign_count = signature_counts.get(uid, 0)
            if user_info:
                name = f"{user_info.get('first_name','')} {user_info.get('last_name',' ')}".strip() or user_info.get('username') or f"ID: {uid}"
                details: List[str] = []; dept = user_info.get('department'); pos = user_info.get('position')
                if dept and dept not in ['–ù–µ —É–∫–∞–∑–∞–Ω','–ù–µ —É–∫–∞–∑–∞–Ω–∞']: details.append(str(dept))
                if pos and pos not in ['–ù–µ —É–∫–∞–∑–∞–Ω','–ù–µ —É–∫–∞–∑–∞–Ω–∞']: details.append(str(pos))
                details_s = ', '.join(details) if details else '–ù/–î'
                full_text += f"   ‚Ä¢ {name} ({details_s}) `ID: {uid}`\n     *–ü–æ–¥–ø–∏—Å–∞–Ω–æ –∞–∫—Ç–æ–≤: {sign_count}*\n"; found_count += 1
            else:
                full_text += f"   ‚Ä¢ ID: {uid} (–ù–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω)\n"
                if sign_count > 0: full_text += f"     *–ü–æ–¥–ø–∏—Å–∞–Ω–æ –∞–∫—Ç–æ–≤: {sign_count}*\n"
        if found_count == 0 and member_ids: full_text += "   (–£—á–∞—Å—Ç–Ω–∏–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã)\n"
    if not any_filled: full_text = "üë• ID –¥–ª—è –∫–æ–º–∏—Å—Å–∏–π –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã."
    for i in range(0, len(full_text), 4000): await update.message.reply_text(full_text[i:i+4000], parse_mode=ParseMode.MARKDOWN)

# (format_timedelta_for_report, _calculate_processing_time_seconds, generate_cargo_report - –∫–∞–∫ –±—ã–ª–∏, generate_cargo_report —Ç–æ–ª—å–∫–æ –¥–ª—è –°—É–ø–µ—Ä –ê–¥–º–∏–Ω–∞)
# ... (–≤—Å—Ç–∞–≤—å—Ç–µ –∫–æ–¥ —ç—Ç–∏—Ö —Ç—Ä–µ—Ö —Ñ—É–Ω–∫—Ü–∏–π)
def format_timedelta_for_report(td_seconds: Optional[float]) -> str:
    if td_seconds is None or td_seconds < 0: return "–ù/–î" 
    td = timedelta(seconds=td_seconds); days = td.days; hours, rem = divmod(td.seconds, 3600); mins, secs = divmod(rem, 60)
    parts = []; 
    if days > 0: parts.append(f"{days} –¥–Ω.")
    if days > 0 or hours > 0 or mins > 0 or secs > 0:
        if not (days > 0 and hours == 0 and mins == 0 and secs == 0): parts.append(f"{hours:02d}:{mins:02d}:{secs:02d}")
    return " ".join(parts) if parts else "–º–µ–Ω–µ–µ 1 —Å–µ–∫."

def _calculate_processing_time_seconds(s_data: Dict[str, Any]) -> Optional[float]:
    p_dt_str = s_data.get('photo_datetime_obj'); d_dt_str = s_data.get('decision_time_obj'); s_id = s_data.get('shipment_id', 'N/A')
    if p_dt_str and d_dt_str and isinstance(p_dt_str, str) and isinstance(d_dt_str, str):
        try:
            p_dt = datetime.fromisoformat(p_dt_str); d_dt = datetime.fromisoformat(d_dt_str)
            if d_dt >= p_dt: return (d_dt - p_dt).total_seconds()
            else: logger.warning(f"–í—Ä–µ–º—è —Ä–µ—à–µ–Ω–∏—è {d_dt} —Ä–∞–Ω—å—à–µ —Ñ–æ—Ç–æ {p_dt} –¥–ª—è {s_id}")
        except ValueError as e: logger.warning(f"–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞—Ç—ã –¥–ª—è {s_id}: {e}")
    return None

async def generate_cargo_report(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    if not update.effective_user or not update.message: return
    if not is_admin(update.effective_user.id): # –¢–æ–ª—å–∫–æ –°—É–ø–µ—Ä –ê–¥–º–∏–Ω
        await update.message.reply_text("–≠—Ç–∞ –∫–æ–º–∞–Ω–¥–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –≥–ª–∞–≤–Ω—ã–º –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º."); return
    if context.bot_data is None: context.bot_data = {}
    s_data_all: Dict[str, Dict[str, Any]] = context.bot_data.get('shipments', {})
    if not s_data_all: await update.message.reply_text("üìä *–û—Ç—á–µ—Ç*\n–ó–∞–ø–∏—Å–µ–π –Ω–µ—Ç.", parse_mode=ParseMode.MARKDOWN); return
    total_s = len(s_data_all)
    s_counts = {'–æ–∂–∏–¥–∞–µ—Ç —Ä–µ—à–µ–Ω–∏—è':0,'–æ–∂–∏–¥–∞–µ—Ç –ø—Ä–æ—Ç–æ–∫–æ–ª':0,'–æ–∂–∏–¥–∞–µ—Ç –ø–æ–¥–ø–∏—Å–∞–Ω–∏—è –∫–æ–º–∏—Å—Å–∏–µ–π':0,'–ø—Ä–∏–Ω—è—Ç–æ (–ø—Ä—è–º–æ–µ/–ª–∞–±.)':0,'–æ—Ç–∫–∞–∑–∞–Ω–æ (–ø—Ä—è–º–æ–µ/–ª–∞–±.)':0,'–ø—Ä–∏–Ω—è—Ç–æ –∫–æ–º–∏—Å—Å–∏–µ–π':0,'–æ—Ç–∫–∞–∑–∞–Ω–æ –∫–æ–º–∏—Å—Å–∏–µ–π':0,'–Ω–µ–∏–∑–≤–µ—Å—Ç–µ–Ω':0}
    for s_id, s_rec in s_data_all.items():
        status, comm_s_status = str(s_rec.get('status','–Ω–µ–∏–∑–≤–µ—Å—Ç–µ–Ω')).lower(), s_rec.get('commission_signing_status')
        final_s = status; 
        if comm_s_status == 'all_signed': final_s = '–ø—Ä–∏–Ω—è—Ç–æ –∫–æ–º–∏—Å—Å–∏–µ–π'
        elif comm_s_status == 'rejected': final_s = '–æ—Ç–∫–∞–∑–∞–Ω–æ –∫–æ–º–∏—Å—Å–∏–µ–π'
        if final_s.startswith('–ø—Ä–∏–Ω—è—Ç–æ'): s_counts['–ø—Ä–∏–Ω—è—Ç–æ –∫–æ–º–∏—Å—Å–∏–µ–π' if '–∫–æ–º–∏—Å—Å–∏–µ–π' in final_s else '–ø—Ä–∏–Ω—è—Ç–æ (–ø—Ä—è–º–æ–µ/–ª–∞–±.)'] += 1
        elif final_s.startswith('–æ—Ç–∫–∞–∑–∞–Ω–æ'): s_counts['–æ—Ç–∫–∞–∑–∞–Ω–æ –∫–æ–º–∏—Å—Å–∏–µ–π' if '–∫–æ–º–∏—Å—Å–∏–µ–π' in final_s else '–æ—Ç–∫–∞–∑–∞–Ω–æ (–ø—Ä—è–º–æ–µ/–ª–∞–±.)'] += 1
        elif final_s in s_counts: s_counts[final_s] += 1
        else: s_counts['–Ω–µ–∏–∑–≤–µ—Å—Ç–µ–Ω'] +=1
    report_txt_parts = [f"üìä *–û—Ç—á–µ—Ç –ø–æ –≥—Ä—É–∑–∞–º*\n–í—Å–µ–≥–æ: {total_s}", "‚îÄ"*20, "*–°–≤–æ–¥–∫–∞:*"]
    for s_name, count in s_counts.items():
        if count > 0 : report_txt_parts.append(f" ‚Ä¢ {s_name.capitalize()}: {count}")
    report_txt_parts.append("‚îÄ"*20)
    sorted_s_detail: List[Dict[str, Any]] = sorted(s_data_all.values(), key=lambda s: datetime.fromisoformat(s['photo_datetime_obj']) if s.get('photo_datetime_obj') and isinstance(s['photo_datetime_obj'], str) else datetime.min, reverse=True)
    if sorted_s_detail: report_txt_parts.append("*–ü–æ—Å–ª–µ–¥–Ω–∏–µ –≥—Ä—É–∑—ã:*")
    for s_det in sorted_s_detail[:5]:
        s_id_d = str(s_det.get('shipment_id','N/A')); sender_d = s_det.get('sender_name','–ù/–î'); ws_d = s_det.get('workshop','–ù/–î')
        rt_d = s_det.get('reception_type','–ù/–î'); pt_s_d = s_det.get('photo_time_str','–ù/–î'); comm_s_s_d = s_det.get('commission_signing_status')
        dm_d = s_det.get('decision_maker_name',''); ci_d = s_det.get('commission_process_initiator_name','')
        status_l_d = f"–°—Ç–∞—Ç—É—Å: *{s_det.get('status','–ù/–î')}*"
        if comm_s_s_d == 'pending':
            sigs_m = s_det.get('commission_signatures',{}); signed_c = sum(1 for sd in sigs_m.values() if isinstance(sd,dict) and sd.get('status')=='signed')
            req_m = s_det.get('required_commission_members',[]); total_m = len(req_m) if isinstance(req_m,list) else 0
            status_l_d += f" (–ö–æ–º: {signed_c}/{total_m} –ø–æ–¥–ø.)"
        elif comm_s_s_d == 'rejected':
            sigs_m_r = s_det.get('commission_signatures',{}); rej_r = "–ù/–£"
            if isinstance(sigs_m_r, dict):
                for _, sd_r in sigs_m_r.items():
                    if isinstance(sd_r,dict) and sd_r.get('status')=='rejected': rej_r = str(sd_r.get('rejection_reason','–ù/–£')); break
            status_l_d += f" (–û—Ç–∫–ª. –∫–æ–º. –ü—Ä–∏—á–∏–Ω–∞: {rej_r[:50]}...)"
        proc_t_s_d = s_det.get('processing_time_str', "–ù/–î")
        if proc_t_s_d == "–ù/–î" or proc_t_s_d is None:
            time_s_d = _calculate_processing_time_seconds(s_det)
            if time_s_d is not None: proc_t_s_d = format_timedelta_for_report(time_s_d)
        details_entry_txt = (f"üÜî `{s_id_d[-6:]}` ({rt_d})\n–û—Ç: {sender_d} –¥–ª—è: {ws_d}\nüì∏ {pt_s_d}\n{status_l_d}\n")
        if dm_d and not ci_d : details_entry_txt += f"üë§ –†–µ—à–µ–Ω–∏–µ: {dm_d}\n"
        if ci_d: details_entry_txt += f"üë• –ö–æ–º–∏—Å—Å–∏—è: {ci_d}\n"
        details_entry_txt += f"‚è±Ô∏è –í—Ä–µ–º—è: {proc_t_s_d}\n"; report_txt_parts.append(details_entry_txt)
    if len(sorted_s_detail) > 5: report_txt_parts.append(f"\n_(–ü–æ–∫–∞–∑–∞–Ω—ã 5 –∏–∑ {len(sorted_s_detail)} –≥—Ä—É–∑–æ–≤.)_")
    full_report = "\n".join(report_txt_parts)
    for i in range(0,len(full_report),4000): await update.message.reply_text(full_report[i:i+4000], parse_mode=ParseMode.MARKDOWN)
    
    # –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –ø–æ–ª–Ω–æ–≥–æ –æ—Ç—á–µ—Ç–∞
    download_button = [[InlineKeyboardButton("üì• –°–∫–∞—á–∞—Ç—å –ø–æ–ª–Ω—ã–π –æ—Ç—á–µ—Ç (CSV)", callback_data="download_full_report")]]
    await update.message.reply_text("–í—ã –º–æ–∂–µ—Ç–µ —Å–∫–∞—á–∞—Ç—å –ø–æ–ª–Ω—ã–π –æ—Ç—á–µ—Ç –≤ —Ñ–æ—Ä–º–∞—Ç–µ CSV.", reply_markup=InlineKeyboardMarkup(download_button))

def _generate_csv_report_bytes(shipments_data: Dict[str, Dict[str, Any]]) -> io.BytesIO:
    output = io.StringIO()
    writer = csv.writer(output, delimiter=';')

    headers = [
        "ID –≥—Ä—É–∑–∞", "–î–∞—Ç–∞/–í—Ä–µ–º—è —Ñ–æ—Ç–æ", "–û—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å", "–¶–µ—Ö/–ü—Ä–æ–µ–∫—Ç", "–ú–µ—Å—Ç–æ –ø—Ä–∏–µ–º–∫–∏", "–¢–∏–ø –ø—Ä–∏–µ–º–∫–∏", 
        "–°—Ç–∞—Ç—É—Å", "–î–∞—Ç–∞/–í—Ä–µ–º—è —Ä–µ—à–µ–Ω–∏—è", "–ö—Ç–æ –ø—Ä–∏–Ω—è–ª —Ä–µ—à–µ–Ω–∏–µ", "–í—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ (—á:–º:—Å)", 
        "–ö–æ–ª-–≤–æ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤", "–ü–æ–¥–ø–∏—Å–∏ –∫–æ–º–∏—Å—Å–∏–∏", "–í—Ä–µ–º—è –Ω–∞ —Ä–µ—à–µ–Ω–∏–µ –ª–∞–±–æ—Ä–∞—Ç–æ—Ä–∏–∏ (—á:–º:—Å)"
    ]
    writer.writerow(headers)

    def _format_signatures_for_csv(signatures: Dict[Any, Dict[str, Any]]) -> str:
        if not signatures: return "–ù/–ü"
        parts = []
        for user_id, sig_data in signatures.items():
            if not isinstance(sig_data, dict): continue
            user_info = get_user_info(int(user_id))
            user_name = f"ID {user_id}"
            if user_info: user_name = f"{user_info.get('first_name','')} {user_info.get('last_name',' ')}".strip() or user_info.get('username') or f"ID {user_id}"
            
            status = sig_data.get('status')
            if status == 'signed':
                timestamp_iso = sig_data.get('timestamp'); time_str = ""
                if timestamp_iso:
                    try: time_str = f" –≤ {datetime.fromisoformat(timestamp_iso).strftime('%H:%M:%S')}"
                    except (ValueError, TypeError): pass
                parts.append(f"{user_name} (–ü–æ–¥–ø–∏—Å–∞–Ω–æ{time_str})")
            elif status == 'rejected':
                reason = sig_data.get('rejection_reason', '–ø—Ä–∏—á–∏–Ω–∞ –Ω–µ —É–∫–∞–∑–∞–Ω–∞')
                parts.append(f"{user_name} (–û—Ç–∫–ª–æ–Ω–µ–Ω–æ: {reason})")
            elif status == 'pending':
                 parts.append(f"{user_name} (–û–∂–∏–¥–∞–µ—Ç)")
        return "; ".join(parts) if parts else "–ù/–ü"

    def _calculate_lab_time_str(s_data: Dict[str, Any]) -> str:
        lab_start_str = s_data.get('lab_check_time_obj')
        decision_str = s_data.get('decision_time_obj')
        if not lab_start_str or not decision_str or s_data.get('status') not in ['–ü—Ä–∏–Ω—è—Ç–æ (–ª–∞–±.)', '–û—Ç–∫–∞–∑–∞–Ω–æ (–ª–∞–±.)']: return "–ù/–ü"
        try: return format_timedelta_for_report((datetime.fromisoformat(decision_str) - datetime.fromisoformat(lab_start_str)).total_seconds())
        except (ValueError, TypeError): return "–û—à–∏–±–∫–∞ —Ä–∞—Å—á–µ—Ç–∞"

    sorted_shipments = sorted(
        shipments_data.values(),
        key=lambda s: datetime.fromisoformat(s['photo_datetime_obj']) if s.get('photo_datetime_obj') and isinstance(s['photo_datetime_obj'], str) else datetime.min,
        reverse=True
    )

    for s_det in sorted_shipments:
        final_status = s_det.get('status', '–ù/–î')
        if s_det.get('commission_signing_status') == 'all_signed': final_status = '–ü—Ä–∏–Ω—è—Ç–æ –∫–æ–º–∏—Å—Å–∏–µ–π'
        elif s_det.get('commission_signing_status') == 'rejected': final_status = '–û—Ç–∫–∞–∑–∞–Ω–æ –∫–æ–º–∏—Å—Å–∏–µ–π'
        row = [
            s_det.get('shipment_id', 'N/A'),
            s_det.get('photo_time_str', '–ù/–î'),
            s_det.get('sender_name', '–ù/–î'),
            s_det.get('workshop', '–ù/–î'),
            s_det.get('receiving_place', '–ù/–î'),
            s_det.get('reception_type', '–ù/–î'),
            final_status,
            datetime.fromisoformat(s_det['decision_time_obj']).strftime('%d.%m.%Y %H:%M') if s_det.get('decision_time_obj') else '–ù/–î',
            s_det.get('decision_maker_name', '–ù/–î'),
            s_det.get('processing_time_str', '–ù/–î'),
            len(s_det.get('documents', [])),
            _format_signatures_for_csv(s_det.get('commission_signatures', {})),
            _calculate_lab_time_str(s_det)
        ]
        writer.writerow(row)
    
    return io.BytesIO(output.getvalue().encode('utf-8-sig')) # utf-8-sig –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ Excel

# (show_detailed_cargo_table_callback, handle_commission_sign_act, _generate_non_conformance_act_text, 
#  commission_ask_rejection_reason, commission_handle_rejection_reason, cancel_rejection_reason, 
#  cancel, error_handler - –∫–æ–¥ —ç—Ç–∏—Ö —Ñ—É–Ω–∫—Ü–∏–π –∫–∞–∫ –≤ –ø—Ä–µ–¥—ã–¥—É—â–µ–º –ø–æ–ª–Ω–æ–º –æ—Ç–≤–µ—Ç–µ, —Å –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö)
# ... (–≤—Å—Ç–∞–≤—å—Ç–µ —Å—é–¥–∞ –∫–æ–¥ —ç—Ç–∏—Ö —Ñ—É–Ω–∫—Ü–∏–π)

async def show_detailed_cargo_table_callback(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    query = update.callback_query; 
    if not query or not query.message: return
    await query.answer(); await query.message.reply_text("–≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –±–æ–ª–µ–µ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è.", parse_mode=ParseMode.MARKDOWN)
    try: await query.edit_message_reply_markup(reply_markup=None)
    except Exception as e: logger.info(f"–ù–µ —É–¥–∞–ª–æ—Å—å —É–±—Ä–∞—Ç—å –∫–Ω–æ–ø–∫—É (—Ç–∞–±–ª–∏—Ü–∞): {e}")

async def download_full_report_handler(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    query = update.callback_query
    if not query or not query.from_user: return
    
    if not is_admin(query.from_user.id):
        await query.answer("‚ùå –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω.", show_alert=True)
        return

    await query.answer("‚è≥ –§–æ—Ä–º–∏—Ä—É–µ–º –æ—Ç—á–µ—Ç...")
    if context.bot_data is None: context.bot_data = {}
    shipments_data = context.bot_data.get('shipments', {})
    if not shipments_data:
        await query.message.reply_text("–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è –æ—Ç—á–µ—Ç–∞.")
        return
    csv_file = _generate_csv_report_bytes(shipments_data)
    await context.bot.send_document(chat_id=query.from_user.id, document=csv_file, filename=f"cargo_report_{datetime.now().strftime('%Y-%m-%d')}.csv")

async def handle_commission_sign_act(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    # (–ö–æ–¥ —Ñ—É–Ω–∫—Ü–∏–∏ –∫–∞–∫ –≤ –ø—Ä–µ–¥—ã–¥—É—â–µ–º –ø–æ–ª–Ω–æ–º —Ñ–∞–π–ª–µ, —Å —É—á–µ—Ç–æ–º –≤—Å–µ—Ö –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏–π)
    query = update.callback_query;
    if not query or not query.from_user or not query.data or not query.message: return
    await query.answer(); user_signer = query.from_user
    try:
        if context.bot_data is None: context.bot_data = {}
        parts = query.data.split('_', 2);
        if len(parts) < 3: await query.edit_message_text("–û—à–∏–±–∫–∞ –¥–∞–Ω–Ω—ã—Ö.",reply_markup=None); return
        _, shipment_id, action = parts
        shipments: Dict[str,Dict[str,Any]] = context.bot_data.setdefault('shipments',{})
        if shipment_id not in shipments: await query.edit_message_text("–ò–Ω—Ñ–æ —É—Å—Ç–∞—Ä–µ–ª–∞.",reply_markup=None); return
        s_data = shipments[shipment_id]
        if s_data.get('commission_signing_status') != 'pending': await query.edit_message_text(f"–ü–æ–¥–ø–∏—Å–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ ({s_data.get('commission_signing_status')}).",reply_markup=None); return
        req_members: list = s_data.get('required_commission_members',[]) # type: ignore
        if not isinstance(req_members, list) or user_signer.id not in req_members: await query.edit_message_text("–í—ã –Ω–µ —á–ª–µ–Ω –∫–æ–º–∏—Å—Å–∏–∏.",reply_markup=None); return
        signatures_comm: Dict[Any,Dict[str,Any]] = s_data.setdefault('commission_signatures',{})
        user_sig = signatures_comm.get(user_signer.id,{})
        if user_sig.get('status')=='signed': await query.edit_message_text("–í—ã —É–∂–µ –ø–æ–¥–ø–∏—Å–∞–ª–∏ —ç—Ç–æ—Ç –∞–∫—Ç.",reply_markup=None); return
        if user_sig.get('status')=='rejected': await query.edit_message_text("–†–∞–Ω–µ–µ –æ—Ç–∫–∞–∑–∞–Ω–æ.",reply_markup=None); return
        signatures_comm[user_signer.id] = {'status':'signed','timestamp':datetime.now().isoformat(),'rejection_reason':None}
        await query.edit_message_text("‚úÖ –ì–æ–ª–æ—Å '–ü–æ–¥–ø–∏—Å–∞–Ω–æ' —É—á—Ç–µ–Ω. –û–∂–∏–¥–∞–µ–º –æ—Å—Ç–∞–ª—å–Ω—ã—Ö.",reply_markup=None)
        all_signed_flag = True; req_members_chk: list = s_data.get('required_commission_members',[]) # type: ignore
        if not isinstance(req_members_chk,list): req_members_chk = []
        for m_id_chk in req_members_chk:
            if signatures_comm.get(m_id_chk,{}).get('status')!='signed': all_signed_flag=False; break
        num_s = sum(1 for sd in signatures_comm.values() if isinstance(sd,dict) and sd.get('status')=='signed'); total_m = len(req_members_chk)
        orig_cap = str(s_data.get('caption_text',"–ò–Ω—Ñ–æ.")); doc_btns_f = _get_document_buttons_for_shipment(shipment_id,s_data.get('documents',[]))
        final_markup: Optional[InlineKeyboardMarkup] = InlineKeyboardMarkup(doc_btns_f) if doc_btns_f else None; updated_cap = orig_cap
        
        if all_signed_flag and total_m > 0:
            s_data['commission_signing_status'] = 'all_signed'; final_stat = f"–ü—Ä–∏–Ω—è—Ç–æ –∫–æ–º–∏—Å—Å–∏–µ–π ({s_data.get('reception_type','')})"
            s_data['status'] = final_stat; s_data['decision_time_obj'] = datetime.now().isoformat()
            proc_s = _calculate_processing_time_seconds(s_data); s_data['processing_time_str'] = format_timedelta_for_report(proc_s) if proc_s is not None else "–ù/–î"
            updated_cap += (f"\n\n*{'‚îÄ'*20}*\nüéâ *–°—Ç–∞—Ç—É—Å: –ê–ö–¢ –ü–û–î–ü–ò–°–ê–ù –ö–û–ú–ò–°–°–ò–ï–ô!*\n" # –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π —Å—Ç–∞—Ç—É—Å
                            f"–ü—Ä–∏–Ω—è—Ç–æ: {datetime.now().strftime('%d.%m.%Y %H:%M')}\n‚è±Ô∏è *–í—Ä–µ–º—è:* {s_data.get('processing_time_str','–ù/–î')}")
            updated_cap += _format_commission_signatures_text(signatures_comm)
            sender_id_final = s_data.get('sender_user_id')
            if sender_id_final and isinstance(sender_id_final, int):
                try: 
                    accepted_msg = await context.bot.send_message(sender_id_final, f"üîî –ì—Ä—É–∑ ID ...{shipment_id[-6:]} –ü–†–ò–ù–Ø–¢ –ö–û–ú–ò–°–°–ò–ï–ô.", parse_mode=ParseMode.MARKDOWN)
                    # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–¥–∞–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 15 —Å–µ–∫—É–Ω–¥
                    await delete_message_after_delay(context, sender_id_final, accepted_msg.message_id, 15)
                except Exception as e: logger.error(f"–ù–µ —É–¥–∞–ª–æ—Å—å —É–≤–µ–¥–æ–º–∏—Ç—å {sender_id_final}: {e}")
        else: # –ï—Å–ª–∏ –µ—â–µ –Ω–µ –≤—Å–µ –ø–æ–¥–ø–∏—Å–∞–ª–∏ –∏–ª–∏ –ø–æ–¥–ø–∏—Å–µ–π –Ω–µ—Ç
            if total_m > 0: updated_cap += (f"\n\n*{'‚îÄ'*20}*\n‚úçÔ∏è *–°—Ç–∞—Ç—É—Å –ê–∫—Ç–∞: –ü–æ–¥–ø–∏—Å–∞–Ω–æ {num_s} –∏–∑ {total_m} ({s_data.get('reception_type','')}).*")
            updated_cap += _format_commission_signatures_text(signatures_comm)
        
        if s_data.get('commission_signing_status') in ['all_signed','rejected']: # –£–¥–∞–ª–µ–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –∫–æ–º–∏—Å—Å–∏–∏
            comm_notif_msgs_del = s_data.get('commission_notification_messages',{})
            if isinstance(comm_notif_msgs_del, dict):
                for uid_s, mid_v in comm_notif_msgs_del.items():
                    try: await context.bot.delete_message(int(uid_s),int(mid_v))
                    except Exception as e: logger.warning(f"–ù–µ —É–¥. —É–¥–∞–ª–∏—Ç—å —É–≤–µ–¥. {mid_v} –¥–ª—è {shipment_id} —É {uid_s}: {e}")
                s_data['commission_notification_messages'] = {}
        
        sent_msgs_s = s_data.get('sent_messages',{});
        if isinstance(sent_msgs_s, dict):
            for chat_id_s, msg_data_s in sent_msgs_s.items():
                try:
                    # –ü–æ–ª—É—á–∞–µ–º ID –ø–µ—Ä–≤–æ–≥–æ —Ñ–æ—Ç–æ –∏–∑ –º–µ–¥–∏–∞-–≥—Ä—É–ø–ø—ã –∏–ª–∏ –æ–±—ã—á–Ω–æ–≥–æ —Ñ–æ—Ç–æ
                    photo_msg_id = msg_data_s.get('photo_msg_id') if isinstance(msg_data_s, dict) else msg_data_s
                    if not photo_msg_id:
                        continue
                    cap_send = updated_cap;
                    if len(cap_send) > 1024: cap_send = cap_send[:1020]+"..."
                    # –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ caption —Ñ–æ—Ç–æ, –±–µ–∑ reply_markup (–∫–Ω–æ–ø–∫–∏ —É–∂–µ –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏)
                    await context.bot.edit_message_caption(int(chat_id_s), int(photo_msg_id), caption=cap_send, parse_mode=ParseMode.MARKDOWN)
                    # –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏, –µ—Å–ª–∏ –æ–Ω–æ –µ—Å—Ç—å
                    action_msg_id_s = msg_data_s.get('action_msg_id') if isinstance(msg_data_s, dict) else None
                    if action_msg_id_s:
                        await context.bot.edit_message_reply_markup(chat_id=int(chat_id_s), message_id=int(action_msg_id_s), reply_markup=final_markup)
                except Exception as e: logger.error(f"–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è (–∫–æ–º–∏—Å—Å–∏—è) {photo_msg_id} –≤ {chat_id_s}: {e}")
    except Exception as e: logger.error(f"–û—à–∏–±–∫–∞ –≤ handle_commission_sign_act –¥–ª—è '{query.data}': {e}", exc_info=True)

def _generate_non_conformance_act_text(shipment_id: str, s_data: Dict[str, Any], r_name: str, r_pos: str, reason: str) -> str:
    # (–ö–æ–¥ —Ñ—É–Ω–∫—Ü–∏–∏ –∫–∞–∫ –≤ –ø—Ä–µ–¥—ã–¥—É—â–µ–º –ø–æ–ª–Ω–æ–º —Ñ–∞–π–ª–µ)
    act_t = datetime.now().strftime('%d.%m.%Y %H:%M'); s_id = shipment_id[-6:]
    txt_parts = [f"‚ö†Ô∏è *–ê–ö–¢ –ù–ï–°–û–û–¢–í–ï–¢–°–¢–í–ò–Ø ‚Ññ ...{s_id}*", f"–î–∞—Ç–∞: {act_t}", f"–ú–µ—Å—Ç–æ: {s_data.get('receiving_place','–ù/–î')}",
        "\n*1. –ò–Ω—Ñ–æ –æ —Ç–æ–≤–∞—Ä–µ:*", str(s_data.get('caption_text','–ò–Ω—Ñ–æ.')),f"ID: {shipment_id}",f"–û—Ç–ø—Ä: {s_data.get('sender_name','–ù/–î')}",
        f"–î–ª—è: {s_data.get('workshop','–ù/–î')}",f"–¢–∏–ø: {s_data.get('reception_type','–ù/–î')}", "\n*2. –ù–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è:*",
        f"–û—Ç–∫–∞–∑–∞–ª: {r_name} ({r_pos})",f"–ü—Ä–∏—á–∏–Ω–∞: {reason}",f"–î–∞—Ç–∞: {act_t}", "\n*3. –ü—Ä–∏—á–∏–Ω—ã (–ø—Ä–µ–¥–ø–æ–ª.):*", "–û—Å–Ω–æ–≤–∞–Ω–∏–µ - –æ—Ç–∫–∞–∑ —á–ª–µ–Ω–∞ –∫–æ–º–∏—Å—Å–∏–∏.",
        "\n*4. –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:*", "- –í–µ—Ä–Ω—É—Ç—å/–ó–∞–º–µ–Ω–∏—Ç—å.","(–í—ã–±—Ä–∞—Ç—å/—É–∫–∞–∑–∞—Ç—å)", "\n*5. –ó–∞–∫–ª—é—á–µ–Ω–∏–µ:*", "–ù–µ —Å–æ–æ—Ç–≤. –ü—Ä–∏–µ–º–∫–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∞.",
        "\n*–ü–æ–¥–ø–∏—Å–∏ (–æ—Ç–∫–∞–∑–∞–≤—à–∏–π):*", f"- {r_name} ({r_pos}) - {act_t}"]
    return "\n".join(txt_parts)

async def commission_ask_rejection_reason(update: Update, context: ContextTypes.DEFAULT_TYPE) -> str:
    # (–ö–æ–¥ —Ñ—É–Ω–∫—Ü–∏–∏ –∫–∞–∫ –≤ –ø—Ä–µ–¥—ã–¥—É—â–µ–º –ø–æ–ª–Ω–æ–º —Ñ–∞–π–ª–µ, —Å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–µ–π user_data –∏ bot_data)
    query = update.callback_query
    if not query or not query.from_user or not query.data or not query.message: return ConversationHandler.END
    await query.answer(); user_rejects = query.from_user
    try:
        if context.user_data is None: context.user_data = {}
        if context.bot_data is None: context.bot_data = {}
        parts = query.data.split('_',2);
        if len(parts)<3: await query.edit_message_text("–û—à–∏–±–∫–∞ –¥–∞–Ω–Ω—ã—Ö.",reply_markup=None); return ConversationHandler.END
        _, s_id, action = parts
        shipments: Dict[str,Dict[str,Any]] = context.bot_data.setdefault('shipments',{})
        if s_id not in shipments: await query.edit_message_text("–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≥—Ä—É–∑–µ —É—Å—Ç–∞—Ä–µ–ª–∞ –∏–ª–∏ –≥—Ä—É–∑ –±—ã–ª —É–¥–∞–ª–µ–Ω.",reply_markup=None); return ConversationHandler.END
        s_data = shipments[s_id]
        if s_data.get('commission_signing_status')!='pending': await query.edit_message_text(f"–ü–æ–¥–ø–∏—Å–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ ({s_data.get('commission_signing_status')}).",reply_markup=None); return ConversationHandler.END
        req_m_rej: list = s_data.get('required_commission_members',[]) # type: ignore
        if not isinstance(req_m_rej,list) or user_rejects.id not in req_m_rej: await query.edit_message_text("–í—ã –Ω–µ —á–ª–µ–Ω –∫–æ–º–∏—Å—Å–∏–∏.",reply_markup=None); return ConversationHandler.END
        signatures_comm_rej: Dict[Any,Dict[str,Any]] = s_data.setdefault('commission_signatures',{})
        user_sig_rej = signatures_comm_rej.get(user_rejects.id,{})
        if user_sig_rej.get('status')=='rejected': await query.edit_message_text("–£–∂–µ –æ—Ç–∫–∞–∑–∞–Ω–æ.",reply_markup=None); return ConversationHandler.END
        if user_sig_rej.get('status')=='signed': await query.edit_message_text("–í—ã —É–∂–µ –ø–æ–¥–ø–∏—Å–∞–ª–∏ —ç—Ç–æ—Ç –∞–∫—Ç. –û—Ç–∫–∞–∑–∞—Ç—å—Å—è –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ.",reply_markup=None); return ConversationHandler.END
        context.user_data['rejecting_shipment_id'] = s_id
        await query.edit_message_text("üìù –£–∫–∞–∂–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É –æ—Ç–∫–∞–∑–∞ (—Å–ª–µ–¥. —Å–æ–æ–±—â–µ–Ω–∏–µ–º).\n–û—Ç–º–µ–Ω–∞: /cancel_reason.",reply_markup=None,parse_mode=ParseMode.MARKDOWN)
        set_user_state(context, user_rejects.id, States.AWAITING_REJECTION_REASON); return States.AWAITING_REJECTION_REASON
    except Exception as e: logger.error(f"–û—à–∏–±–∫–∞ –≤ commission_ask_rejection_reason: {e}", exc_info=True)
    if query.message: await query.edit_message_text("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞.",reply_markup=None)
    return ConversationHandler.END

async def commission_handle_rejection_reason(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    # (–ö–æ–¥ —Ñ—É–Ω–∫—Ü–∏–∏ –∫–∞–∫ –≤ –ø—Ä–µ–¥—ã–¥—É—â–µ–º –ø–æ–ª–Ω–æ–º —Ñ–∞–π–ª–µ, —Å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–µ–π user_data –∏ bot_data)
    if not update.effective_user or not update.message or not update.message.text: return ConversationHandler.END
    user_rejected = update.effective_user; reason = update.message.text
    if context.user_data is None: context.user_data = {}
    s_id = context.user_data.get('rejecting_shipment_id') # –ü–æ–ª—É—á–∞–µ–º ID –≥—Ä—É–∑–∞ –∏–∑ user_data
    clear_user_state(context,user_rejected.id)
    if not s_id or not isinstance(s_id,str): await update.message.reply_text("–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –≥—Ä—É–∑."); return ConversationHandler.END
    if context.bot_data is None: context.bot_data = {}
    shipments: Dict[str,Dict[str,Any]] = context.bot_data.setdefault('shipments',{})
    if s_id not in shipments: await update.message.reply_text("–ò–Ω—Ñ–æ –æ –≥—Ä—É–∑–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞."); return ConversationHandler.END
    s_data = shipments[s_id]
    signatures_comm_hrr: Dict[Any,Dict[str,Any]] = s_data.setdefault('commission_signatures',{}) # type: ignore
    signatures_comm_hrr[user_rejected.id] = {'status':'rejected','timestamp':datetime.now().isoformat(),'rejection_reason':reason}
    s_data['commission_signing_status'] = 'rejected'; final_s_text = f"–û—Ç–∫–∞–∑–∞–Ω–æ –∫–æ–º–∏—Å—Å–∏–µ–π ({s_data.get('reception_type','')})"
    s_data['status'] = final_s_text; s_data['decision_time_obj'] = datetime.now().isoformat()
    proc_s_hrr = _calculate_processing_time_seconds(s_data); s_data['processing_time_str'] = format_timedelta_for_report(proc_s_hrr) if proc_s_hrr is not None else "–ù/–î"
    user_info_rej = get_user_info(user_rejected.id); rej_name = f"{user_info_rej.get('first_name','')} {user_info_rej.get('last_name',' ')}".strip() if user_info_rej else f"ID {user_rejected.id}"
    rej_pos = user_info_rej.get('position','–ù/–î') if user_info_rej else '–ù/–î'
    await update.message.reply_text("üìù –ü—Ä–∏—á–∏–Ω–∞ –æ—Ç–∫–∞–∑–∞ –ø—Ä–∏–Ω—è—Ç–∞. –§–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è –ê–∫—Ç.",parse_mode=ParseMode.MARKDOWN)
    non_conf_report = _generate_non_conformance_act_text(s_id,s_data,rej_name,rej_pos,reason)
    logger.info(f"–ê–ö–¢ –ù–ï–°–û–û–¢–í–ï–¢–°–¢–í–ò–Ø {s_id}:\n{non_conf_report}")
    for admin_uid in ADMIN_IDS:
        try:
            for i in range(0,len(non_conf_report),4000): await context.bot.send_message(admin_uid,non_conf_report[i:i+4000],parse_mode=ParseMode.MARKDOWN)
        except Exception as e: logger.error(f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∞–∫—Ç –∞–¥–º–∏–Ω—É {admin_uid}: {e}")
    orig_cap_hrr = str(s_data.get('caption_text',"–ò–Ω—Ñ–æ.")); doc_btns_hrr = _get_document_buttons_for_shipment(s_id,s_data.get('documents',[]))
    final_markup_hrr: Optional[InlineKeyboardMarkup] = InlineKeyboardMarkup(doc_btns_hrr) if doc_btns_hrr else None
    updated_cap_hrr = orig_cap_hrr + (f"\n\n*{'‚îÄ'*20}*\nüö´ *–°—Ç–∞—Ç—É—Å: –ê–ö–¢ –û–¢–ö–õ–û–ù–ï–ù –ö–û–ú–ò–°–°–ò–ï–ô!*\n–ü—Ä–∏—á–∏–Ω–∞: {reason}\n–û—Ç–∫–ª–æ–Ω–∏–ª: {rej_name} ({rej_pos})\n"
                                   f"–ö–æ–≥–¥–∞: {datetime.now().strftime('%d.%m.%Y %H:%M')}\n‚è±Ô∏è *–í—Ä–µ–º—è:* {s_data.get('processing_time_str','–ù/–î')}")
    updated_cap_hrr += _format_commission_signatures_text(signatures_comm_hrr)
    
    if s_data.get('commission_signing_status') == 'rejected': # –£–¥–∞–ª–µ–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –∫–æ–º–∏—Å—Å–∏–∏
        comm_notif_msgs_del_hrr = s_data.get('commission_notification_messages',{})
        if isinstance(comm_notif_msgs_del_hrr, dict):
            for uid_s_hrr, mid_v_hrr in comm_notif_msgs_del_hrr.items():
                try: await context.bot.delete_message(int(uid_s_hrr),int(mid_v_hrr))
                except Exception as e: logger.warning(f"–ù–µ —É–¥. —É–¥–∞–ª–∏—Ç—å —É–≤–µ–¥. (reject_reason) {mid_v_hrr} —É {uid_s_hrr}: {e}")
            s_data['commission_notification_messages'] = {}

    sent_msgs_hrr = s_data.get('sent_messages',{});
    if isinstance(sent_msgs_hrr, dict):
        for chat_id_s_hrr, msg_data_s_hrr in sent_msgs_hrr.items():
            try:
                # –ü–æ–ª—É—á–∞–µ–º ID –ø–µ—Ä–≤–æ–≥–æ —Ñ–æ—Ç–æ –∏–∑ –º–µ–¥–∏–∞-–≥—Ä—É–ø–ø—ã –∏–ª–∏ –æ–±—ã—á–Ω–æ–≥–æ —Ñ–æ—Ç–æ
                photo_msg_id_hrr = msg_data_s_hrr.get('photo_msg_id') if isinstance(msg_data_s_hrr, dict) else msg_data_s_hrr
                if not photo_msg_id_hrr:
                    continue
                cap_send_hrr = updated_cap_hrr;
                if len(cap_send_hrr)>1024: cap_send_hrr = cap_send_hrr[:1020]+"..."
                # –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ caption —Ñ–æ—Ç–æ, –±–µ–∑ reply_markup (–∫–Ω–æ–ø–∫–∏ —É–∂–µ –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏)
                await context.bot.edit_message_caption(int(chat_id_s_hrr), int(photo_msg_id_hrr), caption=cap_send_hrr, parse_mode=ParseMode.MARKDOWN)
                # –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏, –µ—Å–ª–∏ –æ–Ω–æ –µ—Å—Ç—å
                action_msg_id_hrr = msg_data_s_hrr.get('action_msg_id') if isinstance(msg_data_s_hrr, dict) else None
                if action_msg_id_hrr:
                    await context.bot.edit_message_reply_markup(chat_id=int(chat_id_s_hrr), message_id=int(action_msg_id_hrr), reply_markup=final_markup_hrr)
            except Exception as e: logger.error(f"–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è (–æ—Ç–∫–∞–∑ –∫–æ–º.) {photo_msg_id_hrr} –≤ {chat_id_s_hrr}: {e}")
    sender_id_hrr = s_data.get('sender_user_id')
    if sender_id_hrr and isinstance(sender_id_hrr, int):
        try: 
            rejected_msg = await context.bot.send_message(sender_id_hrr, f"üö´ –ì—Ä—É–∑ ID ...{s_id[-6:]} –û–¢–ö–õ–û–ù–ï–ù –ö–û–ú–ò–°–°–ò–ï–ô.\n–ü—Ä–∏—á–∏–Ω–∞: {reason}", parse_mode=ParseMode.MARKDOWN)
            # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–¥–∞–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 15 —Å–µ–∫—É–Ω–¥
            await delete_message_after_delay(context, sender_id_hrr, rejected_msg.message_id, 15)
        except Exception as e: logger.error(f"–ù–µ —É–¥–∞–ª–æ—Å—å —É–≤–µ–¥–æ–º–∏—Ç—å –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è {sender_id_hrr} –æ–± –æ—Ç–∫–∞–∑–µ: {e}")
    return ConversationHandler.END

async def cancel_rejection_reason(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    if not update.message or not update.effective_user: return ConversationHandler.END
    await update.message.reply_text("–í–≤–æ–¥ –ø—Ä–∏—á–∏–Ω—ã –æ—Ç–∫–∞–∑–∞ –æ—Ç–º–µ–Ω–µ–Ω.")
    clear_user_state(context, update.effective_user.id) # –ü–µ—Ä–µ–¥–∞–µ–º user_id
    return ConversationHandler.END

# --- –û—Ç–º–µ–Ω–∞ –∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫ (–æ–±–Ω–æ–≤–ª–µ–Ω) ---
async def cancel(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    if not update.effective_user or not update.message: return ConversationHandler.END 
    user_id_cancel = update.effective_user.id
    
    # –£–¥–∞–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –¥–∏–∞–ª–æ–≥–∞ –ø–µ—Ä–µ–¥ –æ—Ç–º–µ–Ω–æ–π
    await delete_dialogue_messages(context, user_id_cancel)

    current_state_cancel = get_user_state(context, user_id_cancel) # –ü–µ—Ä–µ–¥–∞–µ–º user_id
    await update.message.reply_text("‚ùå –û–ø–µ—Ä–∞—Ü–∏—è –æ—Ç–º–µ–Ω–µ–Ω–∞.", parse_mode=ParseMode.MARKDOWN)
    is_reg_cancel = current_state_cancel in [States.AWAITING_NAME, States.AWAITING_SURNAME, States.AWAITING_DEPARTMENT, States.AWAITING_POSITION]
    clear_user_state(context, user_id_cancel) # –ü–µ—Ä–µ–¥–∞–µ–º user_id
    if current_state_cancel == States.AWAITING_REJECTION_REASON: pass 
    elif is_reg_cancel: await update.message.reply_text("–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø—Ä–µ—Ä–≤–∞–Ω–∞. –ù–∞–∂–º–∏—Ç–µ /start.", parse_mode=ParseMode.MARKDOWN)
    else: await start(update, context) 
    return ConversationHandler.END

async def error_handler(update: object, context: ContextTypes.DEFAULT_TYPE) -> None:
    logger.error(f"–û—à–∏–±–∫–∞: {context.error}", exc_info=context.error)
    eff_msg = None; eff_uid = None
    if isinstance(update, Update):
        if update.effective_message: eff_msg = update.effective_message
        if update.effective_user: eff_uid = update.effective_user.id
    if eff_msg:
        try: await eff_msg.reply_text("‚ùå *–ù–µ–ø—Ä–µ–¥–≤–∏–¥–µ–Ω–Ω–∞—è –æ—à–∏–±–∫–∞.* –ü–æ–ø—Ä–æ–±—É–π—Ç–µ /start.", parse_mode=ParseMode.MARKDOWN)
        except Exception as e: logger.error(f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ: {e}")
    if eff_uid: await delete_dialogue_messages(context, eff_uid); clear_user_state(context, eff_uid) # –£–¥–∞–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –∏ –æ—á–∏—â–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ

# --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ConversationHandler'–æ–≤ ---

async def clear_cargo_report_command(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """–ó–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –Ω–∞ –æ—á–∏—Å—Ç–∫—É –æ—Ç—á–µ—Ç–∞ –ø–æ –≥—Ä—É–∑–∞–º. –î–æ—Å—Ç—É–ø–Ω–æ —Ç–æ–ª—å–∫–æ –¥–ª—è –°—É–ø–µ—Ä –ê–¥–º–∏–Ω–∞."""
    if not update.effective_user or not update.message: return
    user_id = update.effective_user.id
    
    if not is_admin(user_id):
        await update.message.reply_text("‚ùå –≠—Ç–∞ –∫–æ–º–∞–Ω–¥–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –≥–ª–∞–≤–Ω—ã–º –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º.")
        return

    if context.bot_data is None: context.bot_data = {}
    shipments = context.bot_data.get('shipments', {})
    
    if not shipments:
        await update.message.reply_text("‚úÖ –û—Ç—á–µ—Ç –ø–æ –≥—Ä—É–∑–∞–º —É–∂–µ –ø—É—Å—Ç. –ù–µ—á–µ–≥–æ –æ—á–∏—â–∞—Ç—å.")
        return
        
    confirmation_keyboard = [[
        InlineKeyboardButton("üóëÔ∏è –î–∞, –æ—á–∏—Å—Ç–∏—Ç—å –æ—Ç—á–µ—Ç", callback_data="confirm_clear_report"),
        InlineKeyboardButton("‚ùå –ù–µ—Ç, –æ—Ç–º–µ–Ω–∞", callback_data="cancel_clear_report")
    ]]
    reply_markup = InlineKeyboardMarkup(confirmation_keyboard)
    await update.message.reply_text(
        f"‚ö†Ô∏è *–í–ù–ò–ú–ê–ù–ò–ï!* –í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –ø–æ–ª–Ω–æ—Å—Ç—å—é –æ—á–∏—Å—Ç–∏—Ç—å –æ—Ç—á–µ—Ç –ø–æ –≥—Ä—É–∑–∞–º?\n\n"
        f"–ë—É–¥–µ—Ç —É–¥–∞–ª–µ–Ω–æ *{len(shipments)}* –∑–∞–ø–∏—Å–µ–π –æ –≥—Ä—É–∑–∞—Ö. "
        f"–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ!",
        reply_markup=reply_markup,
        parse_mode=ParseMode.MARKDOWN
    )

async def handle_clear_report_confirmation(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –æ—á–∏—Å—Ç–∫–∏ –æ—Ç—á–µ—Ç–∞."""
    query = update.callback_query
    if not query or not query.from_user or not query.data: return
    user_id = query.from_user.id
    if not is_admin(user_id): await query.answer("‚ùå –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω.", show_alert=True); return
    if query.data == 'confirm_clear_report':
        shipment_count = len(context.bot_data.get('shipments', {}))
        context.bot_data['shipments'] = {}
        logger.info(f"–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä {user_id} –æ—á–∏—Å—Ç–∏–ª –æ—Ç—á–µ—Ç –ø–æ –≥—Ä—É–∑–∞–º. –£–¥–∞–ª–µ–Ω–æ {shipment_count} –∑–∞–ø–∏—Å–µ–π.")
        await query.edit_message_text(f"‚úÖ –û—Ç—á–µ—Ç –ø–æ –≥—Ä—É–∑–∞–º —É—Å–ø–µ—à–Ω–æ –æ—á–∏—â–µ–Ω. –£–¥–∞–ª–µ–Ω–æ {shipment_count} –∑–∞–ø–∏—Å–µ–π.")
    elif query.data == 'cancel_clear_report':
        await query.edit_message_text("‚ùå –û—á–∏—Å—Ç–∫–∞ –æ—Ç—á–µ—Ç–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞.")

commission_rejection_conv_handler = ConversationHandler(
    entry_points=[CallbackQueryHandler(commission_ask_rejection_reason, pattern=r'^commact_.*_rejectreason$')],
    states={ States.AWAITING_REJECTION_REASON: [MessageHandler(filters.TEXT & ~filters.COMMAND, commission_handle_rejection_reason)], },
    fallbacks=[CommandHandler('cancel_reason', cancel_rejection_reason), CommandHandler('cancel', cancel)],
    per_user=True, per_message=False )

# --- –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞ ---
async def main() -> None:
    bot_token = os.getenv('TELEGRAM_BOT_TOKEN') # –°–Ω–∞—á–∞–ª–∞ –ø—ã—Ç–∞–µ–º—Å—è –∏–∑ –æ–∫—Ä—É–∂–µ–Ω–∏—è
    if not bot_token:
        bot_token = '7336851514:AAHHzJch7iatWZN2xHJpbck61zwoJY7m74w' # –ó–ê–ú–ï–ù–ò–¢–ï –≠–¢–û –ù–ê –í–ê–® –ê–ö–¢–£–ê–õ–¨–ù–´–ô –¢–û–ö–ï–ù
        if bot_token == '–í–ê–®_–¢–ï–õ–ï–ì–†–ê–ú_–ë–û–¢_–¢–û–ö–ï–ù' or not bot_token:
            logger.critical("–¢–æ–∫–µ–Ω –±–æ—Ç–∞ –ù–ï –£–°–¢–ê–ù–û–í–õ–ï–ù! –£–∫–∞–∂–∏—Ç–µ –µ–≥–æ –≤ –∫–æ–¥–µ –∏–ª–∏ —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è TELEGRAM_BOT_TOKEN.")
            exit(1)
        else:
            logger.warning("–¢–æ–∫–µ–Ω –±–æ—Ç–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∏–∑ –∫–æ–¥–∞. –î–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è.")

    persistence_obj = PicklePersistence(filepath=f"{FILE_PREFIX}bot_persistence_data.pkl") # –ò—Å–ø–æ–ª—å–∑—É–µ–º FILE_PREFIX
    app_builder = Application.builder().token(bot_token).persistence(persistence_obj)
    app = app_builder.build() # Renamed

    app.add_handler(commission_rejection_conv_handler)

    # CommandHandlers
    app.add_handler(CommandHandler('start', start))
    app.add_handler(CommandHandler('register', start)) 
    app.add_handler(CommandHandler('users', view_users, filters=filters.User(ADMIN_IDS))) # –¢–æ–ª—å–∫–æ –°—É–ø–µ—Ä –ê–¥–º–∏–Ω
    # view_questions —É–¥–∞–ª–µ–Ω
    app.add_handler(CommandHandler('commissions', view_commission_members_from_config, filters=filters.User(ADMIN_IDS))) # –¢–æ–ª—å–∫–æ –°—É–ø–µ—Ä –ê–¥–º–∏–Ω
    app.add_handler(CommandHandler('report', generate_cargo_report, filters=filters.User(ADMIN_IDS))) # –¢–æ–ª—å–∫–æ –°—É–ø–µ—Ä –ê–¥–º–∏–Ω
    app.add_handler(CommandHandler('clear_report', clear_cargo_report_command, filters=filters.User(ADMIN_IDS))) # –¢–æ–ª—å–∫–æ –°—É–ø–µ—Ä –ê–¥–º–∏–Ω
    app.add_handler(CommandHandler('cancel', cancel)) 

    # CallbackQueryHandlers
    app.add_handler(CallbackQueryHandler(handle_registration_choice, pattern=r'^(start_register|cancel_register)$'))
    app.add_handler(CallbackQueryHandler(handle_reception_type_choice, pattern=r'^reception_type_'))
    app.add_handler(CallbackQueryHandler(handle_goods_subtype_choice, pattern=r'^goods_subtype_'))
    app.add_handler(CallbackQueryHandler(handle_photo_choice, pattern=r'^(add_more_photos|finish_photos)$'))
    app.add_handler(CallbackQueryHandler(handle_clear_report_confirmation, pattern=r'^(confirm_clear_report|cancel_clear_report)$'))
    app.add_handler(CallbackQueryHandler(handle_docs, pattern=r'^(add_docs|send_now|doc_\d+|finish_and_send|confirm_send|cancel_send)$'))
    app.add_handler(CallbackQueryHandler(get_document_handler, pattern=r'^getdoc_'))
    app.add_handler(CallbackQueryHandler(handle_commission_sign_act, pattern=r'^commact_.*_sign$'))
    # commission_ask_rejection_reason (—Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞ –¥–ª—è ConversationHandler) —É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω –≤—ã—à–µ
    app.add_handler(CallbackQueryHandler(handle_delete_shipment, pattern=r'^delshipment_'))
    app.add_handler(CallbackQueryHandler(handle_cargo_action, pattern=r'^cargoaction_')) 
    app.add_handler(CallbackQueryHandler(show_detailed_cargo_table_callback, pattern=r'^show_detailed_cargo_table$'))
    app.add_handler(CallbackQueryHandler(download_full_report_handler, pattern=r'^download_full_report$'))

    # MessageHandlers
    app.add_handler(MessageHandler(filters.PHOTO & (~filters.COMMAND), handle_photo)) # –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ç–æ
    app.add_handler(MessageHandler(filters.Document.ALL & (~filters.COMMAND), handle_docs)) # –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
    app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_message))
    
    app.add_error_handler(error_handler)

    await app.initialize() # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ

    logger.info("–ó–∞–ø—É—Å–∫ –±–æ—Ç–∞...")
    # –ó–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç–∞ –≤ –Ω–µ–±–ª–æ–∫–∏—Ä—É—é—â–µ–º —Ä–µ–∂–∏–º–µ.
    await app.updater.start_polling(allowed_updates=Update.ALL_TYPES)
    await app.start()
    
    # –ë–æ—Ç –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –¥–æ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–π –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ (Ctrl+C)
    try:
        while True:
            await asyncio.sleep(1)
    except KeyboardInterrupt:
        logger.info("–û—Å—Ç–∞–Ω–æ–≤–∫–∞ –±–æ—Ç–∞...")
    finally:
        await app.stop()
        await app.updater.stop()

if __name__ == '__main__':
    asyncio.run(main())
